<!-- filepath: f:\Asystent\web_ui\templates\ltm_page.html.new -->
{% extends "base.html" %}

{% block title %}Pamięć Długoterminowa{% endblock %}

{% block head_extra %}
<style>
.memory-entry {
  background-color: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 1rem;
  border-radius: 1rem;
  margin-bottom: 1rem;
  transition: all 0.2s ease;
}

.memory-entry:hover {
  background-color: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

.memory-date {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--gaja-primary);
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.memory-content {
  font-size: 1rem;
  line-height: 1.5;
  margin-bottom: 0.75rem;
}

.memory-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  color: #777;
}

.memory-form textarea {
  border-radius: 1rem;
  padding: 1rem;
  font-size: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background-color: rgba(255, 255, 255, 0.05);
  resize: vertical;
  min-height: 120px;
}

.memory-form textarea:focus {
  border-color: var(--gaja-primary);
  box-shadow: 0 0 0 0.2rem rgba(152, 230, 192, 0.25);
}

.memory-form .btn {
  border-radius: 2rem;
  padding: 0.5rem 2rem;
  font-weight: 600;
}

.date-divider {
  margin: 2rem 0 1rem;
  display: flex;
  align-items: center;
}

.date-divider:before, .date-divider:after {
  content: "";
  flex: 1;
  height: 1px;
  background: rgba(255, 255, 255, 0.2);
}

.date-divider span {
  padding: 0 1rem;
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--gaja-primary);
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">📒 Pamięć Długoterminowa</h1>

    <!-- Memory Form -->
    <div class="card mb-5 memory-form">
        <div class="card-body">
            <h5 class="mb-3">📥 Dodaj nową pamięć:</h5>
            <form id="add-memory-form">
                <div class="mb-3">
                    <textarea class="form-control" id="memory-content" name="content" rows="3" required placeholder="Wpisz informację, którą Gaja powinna zapamiętać..."></textarea>
                </div>
                <div class="d-flex align-items-center">
                    <div class="input-group me-2" style="max-width: 300px;">
                        <span class="input-group-text">Użytkownik:</span>
                        <input type="text" class="form-control" id="memory-user" name="user" placeholder="assistant">
                    </div>
                    <button type="submit" class="btn btn-gaja">➕ Dodaj</button>
                </div>
            </form>
            <div id="add-memory-status" class="mt-2"></div>
        </div>
    </div>

    <!-- Search Memories -->
    <div class="mb-4 d-flex">
        <input type="text" id="search-memory-input" class="form-control me-2" placeholder="Szukaj wspomnień..." value="{{ search_query }}">
        <button id="search-memory-button" class="btn btn-gaja me-2">🔍 Szukaj</button>
        <button id="clear-search-button" class="btn btn-secondary">✖ Wyczyść</button>
    </div>
    <!-- Memories List -->
    <h5 class="mb-3">🕰️ Ostatnie wspomnienia</h5>
    <div id="memory-list">
        {% if memories %}
            {% set current_date = None %}
            {% for memory in memories %}
                {% set memory_date = memory.timestamp.strftime('%Y-%m-%d') if memory.timestamp else 'Nieznana data' %}

                {% if current_date != memory_date %}
                    {% set current_date = memory_date %}
                    <div class="date-divider">
                        <span>🗓️ {{ memory_date }}</span>
                    </div>
                {% endif %}

                <div class="memory-entry" data-id="{{ memory.id }}">
                    <div class="memory-content">{{ memory.content }}</div>
                    <div class="memory-meta">
                        <div>
                            <span class="badge bg-light text-dark me-2">ID: {{ memory.id }}</span>
                            <span class="badge bg-light text-dark">{{ memory.user }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <small class="me-2">{{ memory.timestamp.strftime('%H:%M:%S') if memory.timestamp else 'N/A' }}</small>
                            <button class="btn btn-sm btn-outline-danger delete-memory-button" data-id="{{ memory.id }}">🗑️</button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">Brak zapisanych wspomnień. Dodaj pierwsze wspomnienie powyżej.</div>
        {% endif %}
    </div>
    <div id="delete-memory-status" class="mt-2"></div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addForm = document.getElementById('add-memory-form');
    const deleteButtons = document.querySelectorAll('.delete-memory-button');

    // Add memory form handler
    addForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('memory-content').value.trim();
        const user = document.getElementById('memory-user').value.trim() || 'assistant';
        const statusContainer = document.getElementById('add-memory-status');

        statusContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Dodawanie...';

        fetch('/api/ltm/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, user})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusContainer.innerHTML = '<div class="alert alert-success">Wspomnienie zostało dodane.</div>';
                document.getElementById('memory-content').value = '';
                location.reload(); // Simple solution - reload to show the new memory
            } else {
                statusContainer.innerHTML = `<div class="alert alert-danger">Błąd: ${data.error || 'Wystąpił nieznany błąd'}</div>`;
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `<div class="alert alert-danger">Błąd: ${error.message}</div>`;
        });
    });

    // Delete memory handlers
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const memoryId = this.getAttribute('data-id');
            const statusContainer = document.getElementById('delete-memory-status');

            if (confirm('Czy na pewno chcesz usunąć to wspomnienie?')) {
                statusContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Usuwanie...';

                fetch(`/api/ltm/delete/${memoryId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Find and remove the memory entry from the DOM
                        const memoryEntry = document.querySelector(`.memory-entry[data-id="${memoryId}"]`);
                        if (memoryEntry) {
                            memoryEntry.remove();
                            statusContainer.innerHTML = '<div class="alert alert-success">Wspomnienie zostało usunięte.</div>';
                        }
                    } else {
                        statusContainer.innerHTML = `<div class="alert alert-danger">Błąd: ${data.error || 'Wystąpił nieznany błąd'}</div>`;
                    }
                })
                .catch(error => {
                    statusContainer.innerHTML = `<div class="alert alert-danger">Błąd: ${error.message}</div>`;
                });
            }
        });
    });
});
</script>
{% endblock %}
