<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Dev Playground - Gaja Assistant</title>    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/gaja-branding.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Include main app theme script for dark/light mode -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</head>
<body data-bs-theme="light">
    <div class="container-fluid">        <!-- Header -->
        <div class="playground-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <a href="/plugins" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="fas fa-arrow-left me-1"></i>Powrót do modułów
                        </a>
                        <h1 class="mb-0"><i class="fas fa-code"></i> Enhanced Dev Playground</h1>
                    </div>
                    <p class="mb-0 text-muted">Advanced testing environment for plugins, LLM interactions, and system debugging</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export Results
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Playground Tabs -->
        <div class="playground-tabs">
            <ul class="nav nav-tabs" id="playgroundTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="plugin-tab" data-bs-toggle="tab" data-bs-target="#plugin-content" type="button" role="tab">
                        <i class="fas fa-puzzle-piece"></i> Plugin Testing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="llm-tab" data-bs-toggle="tab" data-bs-target="#llm-content" type="button" role="tab">
                        <i class="fas fa-robot"></i> LLM Testing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug-content" type="button" role="tab">
                        <i class="fas fa-bug"></i> Debugging
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-content" type="button" role="tab">
                        <i class="fas fa-history"></i> Test History
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="playgroundTabContent">
                <!-- Plugin Testing Tab -->
                <div class="tab-pane fade show active" id="plugin-content" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog"></i> Plugin Configuration
                                </div>
                                <div class="card-body">
                                    <form id="pluginForm">
                                        <div class="mb-3">
                                            <label for="pluginSelect" class="form-label">Select Plugin</label>
                                            <select class="form-select" id="pluginSelect" required>
                                                <option value="">Choose a plugin...</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="pluginFunction" class="form-label">Function Name</label>
                                        <input type="text" class="form-control" id="pluginFunction" list="pluginFunctionOptions" placeholder="Select or enter function name" required>
                                        <datalist id="pluginFunctionOptions"></datalist>
                                        </div>

                                        <div class="mb-3">
                                            <label for="pluginParams" class="form-label">Parameters (JSON)</label>
                                            <textarea class="form-control" id="pluginParams" rows="4" placeholder='{"location": "New York", "units": "metric"}'></textarea>
                                            <small class="form-text text-muted">Enter parameters as JSON object</small>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pluginDryRun">
                                                <label class="form-check-label" for="pluginDryRun">
                                                    Dry Run (validate without executing)
                                                </label>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-play"></i> Execute Plugin
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Plugin Presets -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-bookmark"></i> Plugin Presets
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button class="btn btn-success btn-sm" onclick="savePluginPreset()">
                                            <i class="fas fa-save"></i> Save Current as Preset
                                        </button>
                                    </div>
                                    <div id="pluginPresets">
                                        <!-- Presets will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-terminal"></i> Plugin Results
                                </div>
                                <div class="card-body">
                                    <div class="loading-spinner" id="pluginLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Executing plugin...</p>
                                    </div>
                                    <div id="pluginResults" class="result-container">
                                        Ready to execute plugin tests...
                                    </div>
                                </div>
                            </div>

                            <!-- Plugin Metrics -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar"></i> Execution Metrics
                                </div>
                                <div class="card-body">
                                    <div class="metrics-grid" id="pluginMetrics">
                                        <div class="metric-card">
                                            <span class="metric-value" id="pluginExecutionTime">0</span>
                                            <span class="metric-label">Execution Time (ms)</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="pluginSuccessRate">0</span>
                                            <span class="metric-label">Success Rate (%)</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="pluginTotalTests">0</span>
                                            <span class="metric-label">Total Tests</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Testing Tab -->
                <div class="tab-pane fade" id="llm-content" role="tabpanel">
                    <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-brain"></i> LLM Configuration
                        </div>
                        <div class="card-body">
                            <form id="llmForm">
                                <div class="mb-3">
                                    <label for="llmProvider" class="form-label">LLM Provider</label>
                                    <select class="form-select" id="llmProvider" required>
                                        <option value="">Select provider...</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic</option>
                                        <option value="deepseek">DeepSeek</option>
                                        <option value="local">Local Model</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="llmModel" class="form-label">Model</label>
                                    <input type="text" class="form-control" id="llmModel" list="modelOptions" placeholder="Select or enter model" required>
                                    <datalist id="modelOptions"></datalist>
                                </div>

                                        <div class="mb-3">
                                            <label for="llmPrompt" class="form-label">Test Prompt</label>
                                            <textarea class="form-control" id="llmPrompt" rows="6" placeholder="Enter your test prompt here..." required></textarea>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="llmTemperature" class="form-label">Temperature</label>
                                                    <input type="range" class="form-range" id="llmTemperature" min="0" max="2" step="0.1" value="0.7">
                                                    <span id="temperatureValue">0.7</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="llmMaxTokens" class="form-label">Max Tokens</label>
                                                    <input type="number" class="form-control" id="llmMaxTokens" value="500" min="1" max="4000">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="llmDryRun">
                                                <label class="form-check-label" for="llmDryRun">
                                                    Dry Run (count tokens only)
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="intentionOverride" class="form-label">Intention Override (Optional)</label>
                                            <input type="text" class="form-control" id="intentionOverride" placeholder="Force specific intention">
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-rocket"></i> Test LLM
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- LLM Presets -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-bookmark"></i> Prompt Presets
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button class="btn btn-success btn-sm" onclick="saveLLMPreset()">
                                            <i class="fas fa-save"></i> Save Current as Preset
                                        </button>
                                    </div>
                                    <div id="llmPresets">
                                        <!-- Presets will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-comments"></i> LLM Response
                                </div>
                                <div class="card-body">
                                    <div class="loading-spinner" id="llmLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Processing LLM request...</p>
                                    </div>
                                    <div id="llmResults" class="result-container">
                                        Ready to test LLM interactions...
                                    </div>
                                </div>
                            </div>

                            <!-- LLM Metrics -->
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-analytics"></i> Response Metrics
                                </div>
                                <div class="card-body">
                                    <div class="metrics-grid" id="llmMetrics">
                                        <div class="metric-card">
                                            <span class="metric-value" id="llmResponseTime">0</span>
                                            <span class="metric-label">Response Time (ms)</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="llmTokenCount">0</span>
                                            <span class="metric-label">Tokens Used</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="llmCost">$0.00</span>
                                            <span class="metric-label">Estimated Cost</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="llmIntention">-</span>
                                            <span class="metric-label">Detected Intention</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Debugging Tab -->
                <div class="tab-pane fade" id="debug-content" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-search"></i> Intention Detection Debug
                                </div>
                                <div class="card-body">
                                    <form id="debugForm">
                                        <div class="mb-3">
                                            <label for="debugInput" class="form-label">Test Input</label>
                                            <textarea class="form-control" id="debugInput" rows="3" placeholder="Enter text to analyze intention..." required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-magnifying-glass"></i> Analyze Intention
                                        </button>
                                    </form>

                                    <div class="mt-4" id="debugResults" style="display: none;">
                                        <h6>Intention Analysis Results:</h6>
                                        <div id="debugOutput" class="result-container" style="max-height: 300px;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-list"></i> System Status
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Module Status</h6>
                                            <div id="moduleStatus">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="status-indicator status-success"></span>
                                                    <span>Core Module</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="status-indicator status-success"></span>
                                                    <span>AI Module</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="status-indicator status-warning"></span>
                                                    <span>Audio Module</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>API Status</h6>
                                            <div id="apiStatus">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="status-indicator status-success"></span>
                                                    <span>OpenAI API</span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="status-indicator status-error"></span>
                                                    <span>DeepSeek API</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline-primary mt-3" onclick="refreshStatus()">
                                        <i class="fas fa-refresh"></i> Refresh Status
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-tools"></i> Quick Actions
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="testAllModules()">
                                            <i class="fas fa-check-double"></i> Test All Modules
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="clearCache()">
                                            <i class="fas fa-broom"></i> Clear Cache
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportLogs()">
                                            <i class="fas fa-file-export"></i> Export Logs
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="resetSystem()">
                                            <i class="fas fa-power-off"></i> Reset System
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-line"></i> Performance Monitor
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <small class="text-muted">Memory Usage</small>
                                        <div class="progress">
                                            <div class="progress-bar" id="memoryUsage" style="width: 45%">45%</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted">CPU Usage</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" id="cpuUsage" style="width: 23%">23%</div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted">Disk I/O</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" id="diskUsage" style="width: 12%">12%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test History Tab -->
                <div class="tab-pane fade" id="history-content" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-clock"></i> Test History</span>
                                    <div>
                                        <select class="form-select form-select-sm" id="historyFilter" style="width: auto;">
                                            <option value="all">All Tests</option>
                                            <option value="plugin">Plugin Tests</option>
                                            <option value="llm">LLM Tests</option>
                                            <option value="debug">Debug Tests</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="testHistory">
                                        <!-- History items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-pie"></i> Test Statistics
                                </div>
                                <div class="card-body">
                                    <div class="metrics-grid">
                                        <div class="metric-card">
                                            <span class="metric-value" id="totalTests">0</span>
                                            <span class="metric-label">Total Tests</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="successfulTests">0</span>
                                            <span class="metric-label">Successful</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="failedTests">0</span>
                                            <span class="metric-label">Failed</span>
                                        </div>
                                        <div class="metric-card">
                                            <span class="metric-value" id="averageTime">0</span>
                                            <span class="metric-label">Avg Time (ms)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-download"></i> Export Options
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="exportHistoryJSON()">
                                            <i class="fas fa-file-code"></i> Export as JSON
                                        </button>
                                        <button class="btn btn-outline-success" onclick="exportHistoryCSV()">
                                            <i class="fas fa-file-csv"></i> Export as CSV
                                        </button>
                                        <button class="btn btn-outline-info" onclick="generateReport()">
                                            <i class="fas fa-file-pdf"></i> Generate Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
        let pluginPresets = JSON.parse(localStorage.getItem('pluginPresets') || '[]');
        let llmPresets = JSON.parse(localStorage.getItem('llmPresets') || '[]');

        // Initialize plugin metadata storage
        let pluginMetadata = {};
        // Populate plugin select dropdown
        function populatePluginSelect() {
            const select = document.getElementById('pluginSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Choose a plugin...</option>';
            Object.keys(pluginMetadata).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            initializePlayground();
            loadPluginMetadata();
            loadTestHistory();
            loadPresets();
            setupEventListeners();
            document.getElementById('pluginSelect').addEventListener('change', populateFunctionOptions);
        });

        function loadPluginMetadata() {
            // Fetch plugin metadata for function autocompletion
            fetch('/api/playground/plugins')
                .then(res => res.json())
                .then(data => {
                    pluginMetadata = data.plugins || {};
                    populatePluginSelect();
                })
                .catch(err => console.error('Error loading plugin metadata:', err));
        }

        function populateFunctionOptions() {
            const pluginName = document.getElementById('pluginSelect').value;
            const datalist = document.getElementById('pluginFunctionOptions');
            datalist.innerHTML = '';
            const plugin = pluginMetadata[pluginName];
            if (plugin && plugin.sub_commands) {
                plugin.sub_commands.forEach(cmd => {
                    const opt = document.createElement('option');
                    opt.value = cmd.name;
                    datalist.appendChild(opt);
                });
            }
        }

        // Initialize temperature and model selection handlers
        function initializePlayground() {
            // Update temperature display
            document.getElementById('llmTemperature').addEventListener('input', function() {
                document.getElementById('temperatureValue').textContent = this.value;
            });

            // Update model options based on provider
            document.getElementById('llmProvider').addEventListener('change', function() {
                updateModelOptions(this.value);
            });

            // Load initial model options
            updateModelOptions('openai');
        }

        function updateModelOptions(provider) {
            const modelInput = document.getElementById('llmModel');
            const dataList = document.getElementById('modelOptions');
            dataList.innerHTML = '';
            modelInput.value = '';
            const models = {
                'openai': ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo'],
                'anthropic': ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],
                'deepseek': ['deepseek-chat', 'deepseek-coder'],
                'local': ['llama-2-7b', 'llama-2-13b', 'codellama-7b']
            };

            if (models[provider]) {
                models[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    dataList.appendChild(option);
                });
            }
        }

        function setupEventListeners() {
            // Plugin form submission
            document.getElementById('pluginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await executePlugin();
            });

            // LLM form submission
            document.getElementById('llmForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await testLLM();
            });

            // Debug form submission
            document.getElementById('debugForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await analyzeIntention();
            });

            // History filter
            document.getElementById('historyFilter').addEventListener('change', function() {
                filterHistory(this.value);
            });
        }

        // Plugin Testing Functions
        async function executePlugin() {
            const pluginValue = document.getElementById('pluginSelect').value;
            const functionValue = document.getElementById('pluginFunction').value;
            let paramsObj = {};
            try {
                const paramsText = document.getElementById('pluginParams').value || '';
                paramsObj = paramsText ? JSON.parse(paramsText) : {};
            } catch (err) {
                alert('Invalid JSON parameters');
                return;
            }
            const formData = {
                plugin: pluginValue,
                function_name: functionValue,
                parameters: paramsObj,
                dry_run: document.getElementById('pluginDryRun').checked
            };
            // Disable submit to prevent reload
            const execBtn = document.querySelector('#pluginForm button[type=submit]');
            if (execBtn) execBtn.disabled = true;

            showLoading('plugin');
            const startTime = Date.now();

            try {
                const response = await fetch('/api/playground/plugin-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                const endTime = Date.now();
                const executionTime = endTime - startTime;

                displayPluginResults(result, executionTime);
                updatePluginMetrics(executionTime, response.ok);

                // Save to history
                saveTestToHistory('plugin', formData, result, executionTime);

            } catch (error) {
                displayPluginResults({ error: error.message }, 0);
                updatePluginMetrics(0, false);
            } finally {
                hideLoading('plugin');
                if (execBtn) execBtn.disabled = false;
            }
        }

        function displayPluginResults(result, executionTime) {
            const resultsDiv = document.getElementById('pluginResults');
            resultsDiv.innerHTML = JSON.stringify(result, null, 2);
        }

        function updatePluginMetrics(executionTime, success) {
            document.getElementById('pluginExecutionTime').textContent = executionTime;

            // Update success rate and total tests
            const currentTests = parseInt(document.getElementById('pluginTotalTests').textContent) + 1;
            const currentSuccessRate = parseFloat(document.getElementById('pluginSuccessRate').textContent);
            const newSuccessRate = ((currentSuccessRate * (currentTests - 1)) + (success ? 100 : 0)) / currentTests;

            document.getElementById('pluginTotalTests').textContent = currentTests;
            document.getElementById('pluginSuccessRate').textContent = Math.round(newSuccessRate);
        }

        // LLM Testing Functions
        async function testLLM() {
            const formData = {
                provider: document.getElementById('llmProvider').value,
                model: document.getElementById('llmModel').value,
                prompt: document.getElementById('llmPrompt').value,
                temperature: parseFloat(document.getElementById('llmTemperature').value),
                max_tokens: parseInt(document.getElementById('llmMaxTokens').value),
                dry_run: document.getElementById('llmDryRun').checked,
                intention_override: document.getElementById('intentionOverride').value || undefined
            };

            showLoading('llm');
            const startTime = Date.now();

            try {
                const response = await fetch('/api/playground/direct-llm-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                displayLLMResults(result, responseTime);
                updateLLMMetrics(result, responseTime);

                // Save to history
                saveTestToHistory('llm', formData, result, responseTime);

            } catch (error) {
                displayLLMResults({ error: error.message }, 0);
                updateLLMMetrics({ error: error.message }, 0);
            } finally {
                hideLoading('llm');
            }
        }

        function displayLLMResults(result, responseTime) {
            const resultsDiv = document.getElementById('llmResults');
            resultsDiv.innerHTML = JSON.stringify(result, null, 2);
        }

        function updateLLMMetrics(result, responseTime) {
            document.getElementById('llmResponseTime').textContent = responseTime;
            document.getElementById('llmTokenCount').textContent = result.token_count || 0;
            document.getElementById('llmCost').textContent = `$${(result.estimated_cost || 0).toFixed(4)}`;
            document.getElementById('llmIntention').textContent = result.intention || '-';
        }

        // Debug Functions
        async function analyzeIntention() {
            const input = document.getElementById('debugInput').value;

            try {
                const response = await fetch('/api/playground/debug-intention', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: input })
                });

                const result = await response.json();

                document.getElementById('debugResults').style.display = 'block';
                document.getElementById('debugOutput').innerHTML = JSON.stringify(result, null, 2);

                // Save to history
                saveTestToHistory('debug', { input: input }, result, 0);

            } catch (error) {
                document.getElementById('debugResults').style.display = 'block';
                document.getElementById('debugOutput').innerHTML = JSON.stringify({ error: error.message }, null, 2);
            }
        }

        // Preset Management
        function savePluginPreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;

            const preset = {
                name: name,
                plugin: document.getElementById('pluginSelect').value,
                function_name: document.getElementById('pluginFunction').value,
                parameters: document.getElementById('pluginParams').value,
                dry_run: document.getElementById('pluginDryRun').checked,
                created: new Date().toISOString()
            };

            pluginPresets.push(preset);
            localStorage.setItem('pluginPresets', JSON.stringify(pluginPresets));
            loadPresets();
        }

        function saveLLMPreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;

            const preset = {
                name: name,
                provider: document.getElementById('llmProvider').value,
                model: document.getElementById('llmModel').value,
                prompt: document.getElementById('llmPrompt').value,
                temperature: parseFloat(document.getElementById('llmTemperature').value),
                max_tokens: parseInt(document.getElementById('llmMaxTokens').value),
                created: new Date().toISOString()
            };

            llmPresets.push(preset);
            localStorage.setItem('llmPresets', JSON.stringify(llmPresets));
            loadPresets();
        }

        function loadPresets() {
            // Load plugin presets
            const pluginPresetsDiv = document.getElementById('pluginPresets');
            pluginPresetsDiv.innerHTML = '';

            pluginPresets.forEach((preset, index) => {
                const presetDiv = document.createElement('div');
                presetDiv.className = 'preset-item';
                presetDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${preset.name}</strong><br>
                            <small class="text-muted">${preset.plugin} - ${preset.function_name}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadPluginPreset(${index})">Load</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePluginPreset(${index})">Delete</button>
                        </div>
                    </div>
                `;
                pluginPresetsDiv.appendChild(presetDiv);
            });

            // Load LLM presets
            const llmPresetsDiv = document.getElementById('llmPresets');
            llmPresetsDiv.innerHTML = '';

            llmPresets.forEach((preset, index) => {
                const presetDiv = document.createElement('div');
                presetDiv.className = 'preset-item';
                presetDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${preset.name}</strong><br>
                            <small class="text-muted">${preset.provider} - ${preset.model}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadLLMPreset(${index})">Load</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLLMPreset(${index})">Delete</button>
                        </div>
                    </div>
                `;
                llmPresetsDiv.appendChild(presetDiv);
            });
        }

        function loadPluginPreset(index) {
            const preset = pluginPresets[index];
            document.getElementById('pluginSelect').value = preset.plugin;
            document.getElementById('pluginFunction').value = preset.function_name;
            document.getElementById('pluginParams').value = preset.parameters;
            document.getElementById('pluginDryRun').checked = preset.dry_run;
        }

        function loadLLMPreset(index) {
            const preset = llmPresets[index];
            document.getElementById('llmProvider').value = preset.provider;
            updateModelOptions(preset.provider);
            setTimeout(() => {
                document.getElementById('llmModel').value = preset.model;
            }, 100);
            document.getElementById('llmPrompt').value = preset.prompt;
            document.getElementById('llmTemperature').value = preset.temperature;
            document.getElementById('temperatureValue').textContent = preset.temperature;
            document.getElementById('llmMaxTokens').value = preset.max_tokens;
        }

        function deletePluginPreset(index) {
            if (confirm('Delete this preset?')) {
                pluginPresets.splice(index, 1);
                localStorage.setItem('pluginPresets', JSON.stringify(pluginPresets));
                loadPresets();
            }
        }

        function deleteLLMPreset(index) {
            if (confirm('Delete this preset?')) {
                llmPresets.splice(index, 1);
                localStorage.setItem('llmPresets', JSON.stringify(llmPresets));
                loadPresets();
            }
        }

        // History Management
        function saveTestToHistory(type, config, result, executionTime) {
            const historyItem = {
                id: Date.now(),
                type: type,
                timestamp: new Date().toISOString(),
                config: config,
                result: result,
                executionTime: executionTime,
                success: !result.error
            };

            testHistory.unshift(historyItem);

            // Keep only last 100 items
            if (testHistory.length > 100) {
                testHistory = testHistory.slice(0, 100);
            }

            localStorage.setItem('testHistory', JSON.stringify(testHistory));
            loadTestHistory();
            updateHistoryStats();
        }

        function loadTestHistory() {
            const historyDiv = document.getElementById('testHistory');
            historyDiv.innerHTML = '';

            if (testHistory.length === 0) {
                historyDiv.innerHTML = '<p class="text-muted">No test history available.</p>';
                return;
            }

            testHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="status-indicator ${item.success ? 'status-success' : 'status-error'}"></span>
                                <strong>${item.type.toUpperCase()} Test</strong>
                                <span class="badge bg-secondary ms-2">${item.executionTime}ms</span>
                            </div>
                            <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                            <div class="mt-2">
                                <small>${JSON.stringify(item.config).substring(0, 100)}...</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryDetails(${item.id})">View</button>
                            <button class="btn btn-sm btn-outline-success" onclick="rerunTest(${item.id})">Rerun</button>
                        </div>
                    </div>
                `;
                historyDiv.appendChild(historyItem);
            });
        }

        function filterHistory(filter) {
            const filteredHistory = filter === 'all' ? testHistory : testHistory.filter(item => item.type === filter);

            const historyDiv = document.getElementById('testHistory');
            historyDiv.innerHTML = '';

            filteredHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="status-indicator ${item.success ? 'status-success' : 'status-error'}"></span>
                                <strong>${item.type.toUpperCase()} Test</strong>
                                <span class="badge bg-secondary ms-2">${item.executionTime}ms</span>
                            </div>
                            <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                            <div class="mt-2">
                                <small>${JSON.stringify(item.config).substring(0, 100)}...</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryDetails(${item.id})">View</button>
                            <button class="btn btn-sm btn-outline-success" onclick="rerunTest(${item.id})">Rerun</button>
                        </div>
                    </div>
                `;
                historyDiv.appendChild(historyItem);
            });
        }

        function updateHistoryStats() {
            const total = testHistory.length;
            const successful = testHistory.filter(item => item.success).length;
            const failed = total - successful;
            const avgTime = total > 0 ? Math.round(testHistory.reduce((sum, item) => sum + item.executionTime, 0) / total) : 0;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('successfulTests').textContent = successful;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('averageTime').textContent = avgTime;
        }

        function viewHistoryDetails(id) {
            const item = testHistory.find(h => h.id === id);
            if (!item) return;

            const modalContent = `
                <div class="modal fade" id="historyModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${item.type.toUpperCase()} Test Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Configuration:</h6>
                                <pre class="result-container">${JSON.stringify(item.config, null, 2)}</pre>
                                <h6>Result:</h6>
                                <pre class="result-container">${JSON.stringify(item.result, null, 2)}</pre>
                                <h6>Metrics:</h6>
                                <p><strong>Execution Time:</strong> ${item.executionTime}ms</p>
                                <p><strong>Status:</strong> ${item.success ? 'Success' : 'Failed'}</p>
                                <p><strong>Timestamp:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();

            // Clean up modal on hide
            document.getElementById('historyModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function rerunTest(id) {
            const item = testHistory.find(h => h.id === id);
            if (!item) return;

            // Switch to appropriate tab and load configuration
            if (item.type === 'plugin') {
                document.getElementById('plugin-tab').click();
                setTimeout(() => {
                    document.getElementById('pluginSelect').value = item.config.plugin || '';
                    document.getElementById('pluginFunction').value = item.config.function_name || '';
                    document.getElementById('pluginParams').value = item.config.parameters || '';
                    document.getElementById('pluginDryRun').checked = item.config.dry_run || false;
                }, 100);
            } else if (item.type === 'llm') {
                document.getElementById('llm-tab').click();
                setTimeout(() => {
                    document.getElementById('llmProvider').value = item.config.provider || '';
                    updateModelOptions(item.config.provider || '');
                    setTimeout(() => {
                        document.getElementById('llmModel').value = item.config.model || '';
                    }, 100);
                    document.getElementById('llmPrompt').value = item.config.prompt || '';
                    document.getElementById('llmTemperature').value = item.config.temperature || 0.7;
                    document.getElementById('temperatureValue').textContent = item.config.temperature || 0.7;
                    document.getElementById('llmMaxTokens').value = item.config.max_tokens || 500;
                    document.getElementById('llmDryRun').checked = item.config.dry_run || false;
                    document.getElementById('intentionOverride').value = item.config.intention_override || '';
                }, 100);
            } else if (item.type === 'debug') {
                document.getElementById('debug-tab').click();
                setTimeout(() => {
                    document.getElementById('debugInput').value = item.config.input || '';
                }, 100);
            }
        }

        // Utility Functions
        function showLoading(type) {
            document.getElementById(`${type}Loading`).style.display = 'block';
        }

        function hideLoading(type) {
            document.getElementById(`${type}Loading`).style.display = 'none';
        }

        function clearHistory() {
            if (confirm('Clear all test history?')) {
                testHistory = [];
                localStorage.removeItem('testHistory');
                loadTestHistory();
                updateHistoryStats();
            }
        }

        function exportResults() {
            const data = {
                testHistory: testHistory,
                pluginPresets: pluginPresets,
                llmPresets: llmPresets,
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `playground_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportHistoryJSON() {
            const blob = new Blob([JSON.stringify(testHistory, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test_history_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportHistoryCSV() {
            const headers = ['Timestamp', 'Type', 'Success', 'Execution Time (ms)', 'Configuration', 'Result'];
            const rows = testHistory.map(item => [
                item.timestamp,
                item.type,
                item.success,
                item.executionTime,
                JSON.stringify(item.config),
                JSON.stringify(item.result)
            ]);

            const csvContent = [headers, ...rows].map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            alert('PDF report generation feature coming soon!');
        }

        // Debug and System Functions
        async function refreshStatus() {
            try {
                const response = await fetch('/api/playground/system-status', { method: 'GET' });
                if (!response.ok) throw new Error(`Status fetch error: ${response.status}`);
                const data = await response.json();
                // Update module status
                const moduleStatusDiv = document.getElementById('moduleStatus');
                moduleStatusDiv.innerHTML = '';
                Object.entries(data.modules || {}).forEach(([name, info]) => {
                    const container = document.createElement('div');
                    container.classList.add('d-flex', 'align-items-center', 'mb-2');
                    const indicator = document.createElement('span');
                    indicator.classList.add('status-indicator');
                    // Map status to class
                    if (info.status === 'active') indicator.classList.add('status-success');
                    else if (info.status === 'not_found') indicator.classList.add('status-error');
                    else indicator.classList.add('status-warning');
                    const label = document.createElement('span');
                    label.textContent = name.replace(/_/g, ' ');
                    container.append(indicator, label);
                    moduleStatusDiv.appendChild(container);
                });
                // Update API status
                const apiStatusDiv = document.getElementById('apiStatus');
                apiStatusDiv.innerHTML = '';
                Object.entries(data.apis || {}).forEach(([name, info]) => {
                    const container = document.createElement('div');
                    container.classList.add('d-flex', 'align-items-center', 'mb-2');
                    const indicator = document.createElement('span');
                    indicator.classList.add('status-indicator');
                    // Map API status
                    if (info.status === 'active') indicator.classList.add('status-success');
                    else if (info.status === 'error') indicator.classList.add('status-error');
                    else indicator.classList.add('status-warning');
                    const label = document.createElement('span');
                    label.textContent = name;
                    container.append(indicator, label);
                    apiStatusDiv.appendChild(container);
                });
                // Update performance metrics
                if (data.performance) {
                    const memBar = document.getElementById('memoryUsage');
                    if (data.performance.memory !== undefined) {
                        memBar.style.width = `${data.performance.memory}%`;
                        memBar.textContent = `${data.performance.memory}%`;
                    }
                    const cpuBar = document.getElementById('cpuUsage');
                    if (data.performance.cpu !== undefined) {
                        cpuBar.style.width = `${data.performance.cpu}%`;
                        cpuBar.textContent = `${data.performance.cpu}%`;
                    }
                    const diskBar = document.getElementById('diskUsage');
                    if (data.performance.disk !== undefined) {
                        diskBar.style.width = `${data.performance.disk}%`;
                        diskBar.textContent = `${data.performance.disk}%`;
                    }
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
                alert('Failed to refresh system status.');
            }
        }

        function testAllModules() {
            alert('Testing all modules... This may take a few minutes.');
        }

        function clearCache() {
            if (confirm('Clear system cache?')) {
                alert('Cache cleared successfully!');
            }
        }

        function exportLogs() {
            alert('Exporting system logs... Download will start shortly.');
        }

        function resetSystem() {
            if (confirm('Reset system? This will restart all modules.')) {
                alert('System reset initiated...');
            }
        }

        // Initialize statistics on load
        updateHistoryStats();
    </script>
</body>
</html>
