<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gaja - Ustawienia</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .section h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        select, input[type="text"], input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"] {
            width: auto;
        }
        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .btn-test {
            background-color: #e74c3c;
            color: white;
        }
        .btn-test:hover {
            background-color: #c0392b;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #27ae60;
        }
        .status-disconnected {
            background-color: #e74c3c;
        }
        .info-box {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Gaja - Ustawienia</h1>

        <div class="section">
            <h2>üîä Ustawienia audio</h2>
            <div class="form-group">
                <label for="input-device">UrzƒÖdzenie wej≈õciowe (mikrofon):</label>
                <select id="input-device">
                    <option value="">≈Åadowanie...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="output-device">UrzƒÖdzenie wyj≈õciowe (g≈Ço≈õniki):</label>
                <select id="output-device">
                    <option value="">≈Åadowanie...</option>
                </select>
            </div>
            <button class="btn-test" onclick="testAudioDevices()">üé§ Testuj urzƒÖdzenia</button>
        </div>

        <div class="section">
            <h2>üó£Ô∏è Ustawienia g≈Çosu</h2>
            <div class="form-group">
                <label for="wake-word">S≈Çowo aktywujƒÖce:</label>
                <input type="text" id="wake-word" placeholder="gaja">
            </div>
            <div class="form-group">
                <label for="sensitivity">Czu≈Ço≈õƒá detekcji:</label>
                <div class="range-group">
                    <input type="range" id="sensitivity" min="0.1" max="1.0" step="0.1">
                    <span class="range-value" id="sensitivity-value">0.6</span>
                </div>
            </div>
            <div class="form-group">
                <label for="language">Jƒôzyk:</label>
                <select id="language">
                    <option value="pl-PL">Polski</option>
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h2>üëÅÔ∏è Ustawienia overlay</h2>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="overlay-enabled">
                    <label for="overlay-enabled">W≈ÇƒÖcz overlay</label>
                </div>
            </div>
            <div class="form-group">
                <label for="overlay-position">Pozycja overlay:</label>
                <select id="overlay-position">
                    <option value="top-left">G√≥ra-lewo</option>
                    <option value="top-right">G√≥ra-prawo</option>
                    <option value="bottom-left">D√≥≈Ç-lewo</option>
                    <option value="bottom-right">D√≥≈Ç-prawo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="overlay-opacity">Przezroczysto≈õƒá overlay:</label>
                <div class="range-group">
                    <input type="range" id="overlay-opacity" min="0.1" max="1.0" step="0.1">
                    <span class="range-value" id="overlay-opacity-value">0.9</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìÖ Ustawienia daily briefing</h2>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="daily-briefing-enabled">
                    <label for="daily-briefing-enabled">W≈ÇƒÖcz daily briefing</label>
                </div>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="startup-briefing">
                    <label for="startup-briefing">Briefing przy starcie</label>
                </div>
            </div>
            <div class="form-group">
                <label for="briefing-time">Czas briefingu:</label>
                <input type="text" id="briefing-time" placeholder="08:00">
            </div>
            <div class="form-group">
                <label for="location">Lokalizacja:</label>
                <input type="text" id="location" placeholder="Warszawa">
            </div>
        </div>

        <div class="section">
            <h2>üîß Testy systemu</h2>
            <div class="form-group">
                <button class="btn-test" onclick="testTTS()">üó£Ô∏è Testuj TTS</button>
                <button class="btn-test" onclick="testWakeword()">üé§ Testuj s≈Çowo aktywujƒÖce</button>
                <button class="btn-test" onclick="testConnection()">üåê Testuj po≈ÇƒÖczenie</button>
            </div>
            <div class="info-box">
                <p><strong>Status po≈ÇƒÖczenia:</strong>
                    <span class="status-indicator" id="connection-status"></span>
                    <span id="connection-text">Sprawdzanie...</span>
                </p>
                <p><strong>Wersja klienta:</strong> <span id="client-version">Nieznana</span></p>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="saveSettings()">üíæ Zapisz ustawienia</button>
            <button class="btn-secondary" onclick="resetSettings()">üîÑ Resetuj do domy≈õlnych</button>
            <button class="btn-secondary" onclick="closeSettings()">‚ùå Zamknij</button>
        </div>

        <div id="message-area"></div>
    </div>

    <script>
        // Initialize Tauri API
        const { invoke } = window.__TAURI__.tauri;
        const { emit, listen } = window.__TAURI__.event;

        let currentSettings = {};
        let audioDevices = { input_devices: [], output_devices: [] };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            await loadAudioDevices();
            await checkConnection();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Range inputs
            document.getElementById('sensitivity').addEventListener('input', (e) => {
                document.getElementById('sensitivity-value').textContent = e.target.value;
            });

            document.getElementById('overlay-opacity').addEventListener('input', (e) => {
                document.getElementById('overlay-opacity-value').textContent = e.target.value;
            });
        }

        // Load settings from backend
        async function loadSettings() {
            try {
                const settings = await invoke('get_settings');
                currentSettings = settings;
                updateUI(settings);
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('B≈ÇƒÖd ≈Çadowania ustawie≈Ñ: ' + error, 'error');
            }
        }

        // Load audio devices
        async function loadAudioDevices() {
            try {
                const devices = await invoke('get_audio_devices');
                audioDevices = devices;
                updateAudioDeviceOptions();
            } catch (error) {
                console.error('Error loading audio devices:', error);
                showMessage('B≈ÇƒÖd ≈Çadowania urzƒÖdze≈Ñ audio: ' + error, 'error');
            }
        }

        // Update UI with settings
        function updateUI(settings) {
            // Audio settings
            document.getElementById('input-device').value = settings.audio.input_device || '';
            document.getElementById('output-device').value = settings.audio.output_device || '';

            // Voice settings
            document.getElementById('wake-word').value = settings.voice.wake_word || 'gaja';
            document.getElementById('sensitivity').value = settings.voice.sensitivity || 0.6;
            document.getElementById('sensitivity-value').textContent = settings.voice.sensitivity || 0.6;
            document.getElementById('language').value = settings.voice.language || 'pl-PL';

            // Overlay settings
            document.getElementById('overlay-enabled').checked = settings.overlay.enabled;
            document.getElementById('overlay-position').value = settings.overlay.position || 'top-right';
            document.getElementById('overlay-opacity').value = settings.overlay.opacity || 0.9;
            document.getElementById('overlay-opacity-value').textContent = settings.overlay.opacity || 0.9;

            // Daily briefing settings
            document.getElementById('daily-briefing-enabled').checked = settings.daily_briefing.enabled;
            document.getElementById('startup-briefing').checked = settings.daily_briefing.startup_briefing;
            document.getElementById('briefing-time').value = settings.daily_briefing.briefing_time || '08:00';
            document.getElementById('location').value = settings.daily_briefing.location || 'Warszawa';
        }

        // Update audio device options
        function updateAudioDeviceOptions() {
            const inputSelect = document.getElementById('input-device');
            const outputSelect = document.getElementById('output-device');

            // Clear existing options
            inputSelect.innerHTML = '<option value="">Wybierz urzƒÖdzenie wej≈õciowe...</option>';
            outputSelect.innerHTML = '<option value="">Wybierz urzƒÖdzenie wyj≈õciowe...</option>';

            // Add input devices
            audioDevices.input_devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name + (device.is_default ? ' (domy≈õlny)' : '');
                inputSelect.appendChild(option);
            });

            // Add output devices
            audioDevices.output_devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name + (device.is_default ? ' (domy≈õlny)' : '');
                outputSelect.appendChild(option);
            });
        }

        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    audio: {
                        input_device: document.getElementById('input-device').value || null,
                        output_device: document.getElementById('output-device').value || null
                    },
                    voice: {
                        wake_word: document.getElementById('wake-word').value,
                        sensitivity: parseFloat(document.getElementById('sensitivity').value),
                        language: document.getElementById('language').value
                    },
                    overlay: {
                        enabled: document.getElementById('overlay-enabled').checked,
                        position: document.getElementById('overlay-position').value,
                        opacity: parseFloat(document.getElementById('overlay-opacity').value)
                    },
                    daily_briefing: {
                        enabled: document.getElementById('daily-briefing-enabled').checked,
                        startup_briefing: document.getElementById('startup-briefing').checked,
                        briefing_time: document.getElementById('briefing-time').value,
                        location: document.getElementById('location').value
                    }
                };

                await invoke('save_settings', { settings });
                showMessage('Ustawienia zosta≈Çy zapisane pomy≈õlnie!', 'success');

                // Update current settings
                currentSettings = settings;

            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('B≈ÇƒÖd zapisywania ustawie≈Ñ: ' + error, 'error');
            }
        }

        // Reset settings to defaults
        async function resetSettings() {
            if (confirm('Czy na pewno chcesz przywr√≥ciƒá ustawienia domy≈õlne?')) {
                try {
                    await invoke('reset_settings');
                    await loadSettings();
                    showMessage('Ustawienia zosta≈Çy przywr√≥cone do domy≈õlnych', 'success');
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showMessage('B≈ÇƒÖd resetowania ustawie≈Ñ: ' + error, 'error');
                }
            }
        }

        // Test functions
        async function testTTS() {
            try {
                await invoke('test_tts', { text: 'Test syntezatora mowy dzia≈Ça poprawnie.' });
                showMessage('Test TTS uruchomiony', 'success');
            } catch (error) {
                console.error('Error testing TTS:', error);
                showMessage('B≈ÇƒÖd testu TTS: ' + error, 'error');
            }
        }

        async function testWakeword() {
            try {
                await invoke('test_wakeword', { query: 'Powiedz mi co≈õ o sobie.' });
                showMessage('Test s≈Çowa aktywujƒÖcego uruchomiony', 'success');
            } catch (error) {
                console.error('Error testing wakeword:', error);
                showMessage('B≈ÇƒÖd testu s≈Çowa aktywujƒÖcego: ' + error, 'error');
            }
        }

        async function testConnection() {
            try {
                const status = await invoke('test_connection');
                showMessage('Test po≈ÇƒÖczenia: ' + status, 'success');
                await checkConnection();
            } catch (error) {
                console.error('Error testing connection:', error);
                showMessage('B≈ÇƒÖd testu po≈ÇƒÖczenia: ' + error, 'error');
            }
        }

        async function testAudioDevices() {
            try {
                await invoke('test_audio_devices');
                showMessage('Test urzƒÖdze≈Ñ audio uruchomiony', 'success');
            } catch (error) {
                console.error('Error testing audio devices:', error);
                showMessage('B≈ÇƒÖd testu urzƒÖdze≈Ñ audio: ' + error, 'error');
            }
        }

        // Check connection status
        async function checkConnection() {
            try {
                const connected = await invoke('check_connection');
                const statusElement = document.getElementById('connection-status');
                const textElement = document.getElementById('connection-text');

                if (connected) {
                    statusElement.className = 'status-indicator status-connected';
                    textElement.textContent = 'Po≈ÇƒÖczono';
                } else {
                    statusElement.className = 'status-indicator status-disconnected';
                    textElement.textContent = 'Roz≈ÇƒÖczono';
                }
            } catch (error) {
                console.error('Error checking connection:', error);
                const statusElement = document.getElementById('connection-status');
                const textElement = document.getElementById('connection-text');
                statusElement.className = 'status-indicator status-disconnected';
                textElement.textContent = 'B≈ÇƒÖd sprawdzania';
            }
        }

        // Close settings window
        async function closeSettings() {
            try {
                await invoke('close_settings');
            } catch (error) {
                console.error('Error closing settings:', error);
                // Fallback - try to close via window
                window.close();
            }
        }

        // Show message
        function showMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('JavaScript error:', event.error);
            showMessage('B≈ÇƒÖd aplikacji: ' + event.error.message, 'error');
        });
    </script>
</body>
</html>
