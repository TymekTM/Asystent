{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="gaja-welcome">
        <h1>Moduły AI</h1>
        <p>Lista modułów i pluginów dla Gai. Tutaj możesz zarządzać funkcjonalnościami swojego asystenta.</p>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dostępne moduły</h2>        <div class="module-filters">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-gaja btn-gaja-primary active text-center" id="filter-all"><i class="fas fa-list me-1"></i>Pokaż wszystkie</button>
                <button type="button" class="btn btn-gaja text-center" id="filter-active"><i class="fas fa-check-circle me-1"></i>Tylko aktywne</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-puzzle-piece me-2"></i>Moduły systemowe</span>
            <button class="btn btn-gaja btn-sm" id="add-module"><i class="fas fa-plus me-1"></i>Dodaj moduł</button>
        </div>
        <div class="card-body">
            <div id="plugin-list-section">
                <div class="alert alert-info">Ładowanie listy modułów...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function fetchPlugins(showOnlyActive = false) {
    fetch('/api/plugins')
        .then(r => {
            if (!r.ok) throw new Error('Błąd API: ' + r.status);
            return r.json();
        })
        .then(data => {
            renderPluginList(data, showOnlyActive);
            initTooltips();
        })
        .catch(err => {
            document.getElementById('plugin-list-section').innerHTML = `<div class='alert alert-danger'>Błąd ładowania modułów: ${err.message}</div>`;
        });
}
// Keep track of all plugins for filtering
let allPlugins = {};

function renderPluginList(plugins, showOnlyActive = false) {
    allPlugins = plugins;
    
    if (!Object.keys(plugins).length) {
        document.getElementById('plugin-list-section').innerHTML = '<div class="alert alert-warning">Brak modułów do wyświetlenia.</div>';
        return;
    }
    
    let filteredPlugins = showOnlyActive 
        ? Object.fromEntries(Object.entries(plugins).filter(([_, info]) => info.enabled)) 
        : plugins;
    
    if (showOnlyActive && Object.keys(filteredPlugins).length === 0) {
        document.getElementById('plugin-list-section').innerHTML = '<div class="alert alert-info">Brak aktywnych modułów. Zmień filtr, aby zobaczyć wszystkie dostępne moduły.</div>';
        return;
    }
    
    let html = '<div class="row">';
    for (const [name, info] of Object.entries(filteredPlugins)) {
        html += `
        <div class="col-md-4 mb-4">
            <div class="card module-card h-100 ${info.enabled ? 'active' : ''}" data-bs-toggle="tooltip" title="Moduł: ${name}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-${getModuleIcon(name)} me-2"></i>${name}</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="switch-${name}" 
                            ${info.enabled ? 'checked' : ''} 
                            onchange="togglePlugin('${name}', ${info.enabled})"
                            data-bs-toggle="tooltip" 
                            title="${info.enabled ? 'Dezaktywuj moduł' : 'Aktywuj moduł'}">
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="me-2">Status:</span>
                        <span class="badge ${info.enabled ? 'bg-success' : 'bg-secondary'} ${info.enabled ? 'pulse' : ''}">
                            ${info.enabled ? 'Aktywny' : 'Nieaktywny'}
                        </span>
                    </div>
                    <button class="btn btn-gaja btn-sm" onclick="reloadPlugin('${name}')" data-bs-toggle="tooltip" title="Przeładuj ten moduł">
                        <i class="fas fa-sync-alt me-1"></i>Przeładuj
                    </button>
                </div>
            </div>
        </div>`;}
    html += '</div>';
    document.getElementById('plugin-list-section').innerHTML = html;
}
function getModuleIcon(name) {
    // Map module names to appropriate Font Awesome icons
    const iconMap = {
        'weather_module': 'cloud-sun',
        'core_module': 'microchip',
        'memory_module': 'brain',
        'search_module': 'search',
        'see_screen_module': 'desktop',
        'open_web_module': 'globe',
        'api_module': 'plug',
        'deepseek_module': 'robot'
    };
    
    // Return appropriate icon or default to puzzle-piece
    return iconMap[name] || 'puzzle-piece';
}

function togglePlugin(name, enabled) {
    fetch(`/api/plugins/${name}/${enabled ? 'disable' : 'enable'}`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            // Keep the current filter setting when refreshing
            let showOnlyActive = document.getElementById('filter-active').classList.contains('active');
            fetchPlugins(showOnlyActive);
        });
}

function reloadPlugin(name) {
    fetch(`/api/plugins/${name}/reload`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            // Keep the current filter setting when refreshing
            let showOnlyActive = document.getElementById('filter-active').classList.contains('active');
            fetchPlugins(showOnlyActive);
        });
}

function initModuleFilters() {
    document.getElementById('filter-all').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('filter-active').classList.remove('active');
        renderPluginList(allPlugins, false);
        initTooltips();
    });
    
    document.getElementById('filter-active').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('filter-all').classList.remove('active');
        renderPluginList(allPlugins, true);
        initTooltips();
    });
}

function initTooltips() {
    // Initialize all tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            placement: 'auto'
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    fetchPlugins();
    initModuleFilters();
      // Add module button click handler
    document.getElementById('add-module').addEventListener('click', function() {
        window.location.href = '/api/modules/new';
    });
});
</script>
{% endblock %}
