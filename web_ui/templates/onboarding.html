<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Witaj w Asystencie - Onboarding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gaja-branding.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --onboarding-step-count: 6;
        }
        
        body {
            font-family: var(--gaja-font-family);
            background-color: var(--bg);
            color: var(--text);
            padding-top: 20px;
            min-height: 100vh;
        }
        
        .onboarding-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            border-radius: var(--gaja-border-radius-xl);
            backdrop-filter: blur(10px);
            box-shadow: var(--gaja-shadow);
            padding: 30px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .step.active {
            display: block;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
            height: 4px;
            background: rgba(0,0,0,0.08);
            border-radius: 2px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 4px;
            background: var(--gaja-mint);
            border-radius: 2px;
            width: calc(100% * (1 / var(--onboarding-step-count)));
            transition: width 0.3s ease;
        }
        
        .step-indicator[data-step="1"]::before { width: calc(100% * (1 / var(--onboarding-step-count))); }
        .step-indicator[data-step="2"]::before { width: calc(100% * (2 / var(--onboarding-step-count))); }
        .step-indicator[data-step="3"]::before { width: calc(100% * (3 / var(--onboarding-step-count))); }
        .step-indicator[data-step="4"]::before { width: calc(100% * (4 / var(--onboarding-step-count))); }
        .step-indicator[data-step="5"]::before { width: 100%; }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
            margin: 0 8px;
            cursor: pointer;
            position: relative;
            top: -4px;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: var(--gaja-mint);
            transform: scale(1.2);
        }
        
        .btn-navigation {
            min-width: 120px;
            border-radius: 30px;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--gaja-mint);
            border-color: var(--gaja-mint);
            color: var(--gaja-charcoal);
        }
        
        .btn-primary:hover {
            background-color: #7ad0a8;
            border-color: #7ad0a8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-outline-secondary {
            border-color: var(--gaja-blue);
            color: var(--gaja-charcoal);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--gaja-blue);
            border-color: var(--gaja-blue);
            color: var(--gaja-charcoal);
        }
        
        .onboarding-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--gaja-charcoal);
        }
        
        .onboarding-header h1 {
            font-weight: 600;
            background: linear-gradient(135deg, var(--gaja-mint), var(--gaja-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .feature-box {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(152, 230, 192, 0.3);
            border-radius: var(--gaja-border-radius-xl);
            padding: 25px;
            height: 100%;
            margin-bottom: 20px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .feature-box:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            transform: translateY(-5px);
            border-color: var(--gaja-mint);
        }
        
        .feature-icon {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--gaja-mint), var(--gaja-blue));
            color: white;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(152, 230, 192, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .config-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--gaja-charcoal);
        }
        
        .form-control, .form-select {
            border-radius: var(--gaja-border-radius-xl);
            padding: 12px 15px;
            border: 1px solid rgba(176, 217, 232, 0.5);
            background-color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(152, 230, 192, 0.3);
            border-color: var(--gaja-mint);
        }
        
        .completion-message {
            text-align: center;
            padding: 30px;
        }
        
        .completion-icon {
            font-size: 5rem;
            color: var(--gaja-mint);
            margin-bottom: 20px;
        }
        
        
        .capability-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--gaja-border-radius-xl);
            border: 1px solid rgba(152, 230, 192, 0.3);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .capability-card:hover {
            border-color: var(--gaja-mint);
            transform: translateY(-3px);
            box-shadow: var(--gaja-shadow);
        }
        
        .capability-icon {
            background: linear-gradient(135deg, var(--gaja-mint), var(--gaja-blue));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.25rem;
        }
        
        .info-icon {
            margin-left: 5px;
            color: var(--gaja-blue);
            cursor: help;
        }
        
        .device-refresh-btn {
            margin-left: 10px;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-color: var(--gaja-blue);
            color: var(--gaja-charcoal);
        }
        
        .device-refresh-btn:hover {
            background-color: var(--gaja-blue);
            color: var(--gaja-charcoal);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="onboarding-container">
            <div class="onboarding-header">
                <h1 class="display-4">Witaj w Gai</h1>
                <p class="lead">Przejd≈∫ przez kilka prostych krok√≥w, aby skonfigurowaƒá swojego asystenta</p>
            </div>

            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
                <div class="step-dot" data-step="5"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="step active" id="step-1">
                <div class="text-center mb-5">
                    <h2>Gaja to asystent przysz≈Ço≈õci</h2>
                    <p class="lead">Tw√≥j osobisty asystent AI, kt√≥ry dzia≈Ça lokalnie i rozumie Ciƒô lepiej ni≈º inni.</p>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="feature-box text-center">
                            <div class="feature-icon">üéØ</div>
                            <h4>Inteligentne odpowiedzi</h4>
                            <p>Gaja rozumie Twoje pytania i odpowiada jak cz≈Çowiek - szybko, trafnie i bez ≈õciemy.</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="feature-box text-center">
                            <div class="feature-icon">üé§</div>
                            <h4>Sterowanie g≈Çosem</h4>
                            <p>M√≥w naturalnie - Gaja rozpozna Ciƒô i odpowie g≈Çosem. Nie musisz nic klikaƒá.</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="feature-box text-center">
                            <div class="feature-icon">üîç</div>
                            <h4>Wyszukiwanie informacji</h4>
                            <p>Potrzebujesz fakt√≥w? Gaja b≈Çyskawicznie znajdzie i poda to, czego szukasz.</p>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary btn-navigation" disabled>Wstecz</button>
                    <button class="btn btn-primary btn-navigation next-step">Dalej</button>
                </div>
            </div>            <!-- Step 2: Basic Configuration -->
            <div class="step" id="step-2">
                <h2 class="mb-4">Podstawowa konfiguracja</h2>
                <div class="config-form">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Twoje imiƒô</label>
                        <input type="text" class="form-control" id="userName" placeholder="np. Jan">
                        <div class="form-text">Asystent bƒôdzie zwracaƒá siƒô do Ciebie po imieniu.</div>
                    </div>
                    <div class="mb-3">
                        <label for="assistantName" class="form-label">Nazwa asystenta</label>
                        <input type="text" class="form-control" id="assistantName" value="Gaja">
                        <div class="form-text">Nazwa, kt√≥rƒÖ asystent bƒôdzie siƒô pos≈Çugiwaƒá.</div>
                    </div>
                    <div class="mb-3">
                        <label for="mic-device-id-select" class="form-label">Wybierz mikrofon</label>
                        <div class="input-group">
                            <select class="form-select" id="mic-device-id-select"></select>
                            <button class="btn btn-outline-secondary device-refresh-btn" id="refresh-mic-devices-btn" type="button"><i class="fa fa-sync-alt"></i></button>
                        </div>
                        <div class="form-text">Wybierz urzƒÖdzenie mikrofonu do nas≈Çuchiwania.</div>
                    </div>
                    <div class="mb-3">
                        <label for="language" class="form-label">Jƒôzyk</label>
                        <select class="form-select" id="language">
                            <option value="pl-PL" selected>Polski</option>
                            <option value="en-US">English</option>
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary btn-navigation prev-step">Wstecz</button>
                    <button class="btn btn-primary btn-navigation next-step">Dalej</button>
                </div>
            </div>

            <!-- Step 3: Provider Configuration -->
            <div class="step" id="step-3">
                <h2 class="mb-4">Wybierz provider i model</h2>
                <div class="config-form">
                    <div class="mb-3">
                        <label for="providerSelect" class="form-label">Provider</label>
                        <select class="form-select" id="providerSelect">
                            <option value="openai">OpenAI</option>
                            <option value="azure">Azure</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="deepseek">Deepseek</option>
                            <option value="local">Local</option>
                        </select>
                    </div>
                    <div class="mb-3 api-key-field" id="openaiFields">
                        <label for="openaiModelInput" class="form-label">Model OpenAI</label>
                        <input type="text" class="form-control" id="openaiModelInput" placeholder="gpt-4.1-nano">
                        <label for="openaiKeyInput" class="form-label mt-3">Klucz API</label>
                        <input type="password" class="form-control" id="openaiKeyInput">
                    </div>
                    <div class="mb-3 api-key-field d-none" id="azureFields">
                        <label for="azureModelInput" class="form-label">Model Azure</label>
                        <input type="text" class="form-control" id="azureModelInput" placeholder="default">
                        <label for="azureKeyInput" class="form-label mt-3">Klucz Azure</label>
                        <input type="password" class="form-control" id="azureKeyInput">
                    </div>
                    <!-- Anthropic -->
                    <div class="mb-3 api-key-field d-none" id="anthropicFields">
                        <label for="anthropicModelInput" class="form-label">Model Anthropic</label>
                        <input type="text" class="form-control" id="anthropicModelInput" placeholder="claude-3.5">
                        <label for="anthropicKeyInput" class="form-label mt-3">Anthropic API Key</label>
                        <input type="password" class="form-control" id="anthropicKeyInput">
                    </div>
                    <!-- Deepseek -->
                    <div class="mb-3 api-key-field d-none" id="deepseekFields">
                        <label for="deepseekModelInput" class="form-label">Model Deepseek</label>
                        <input type="text" class="form-control" id="deepseekModelInput" placeholder="deepseek-v3">
                        <label for="deepseekKeyInput" class="form-label mt-3">Deepseek API Key</label>
                        <input type="password" class="form-control" id="deepseekKeyInput">
                    </div>
                    <!-- Local -->
                    <div class="mb-3 api-key-field d-none" id="localFields">
                        <label for="localAddressInput" class="form-label">Local Endpoint Address</label>
                        <input type="text" class="form-control" id="localAddressInput" placeholder="http://localhost:8000">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary btn-navigation prev-step">Wstecz</button>
                    <button class="btn btn-primary btn-navigation next-step">Dalej</button>
                </div>
            </div>

            <!-- Step 4: Funkcje Asystenta -->
            <div class="step" id="step-4">
                <h2 class="mb-4">Co potrafi Gaja?</h2>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="capability-card d-flex flex-column align-items-center text-center">
                            <div class="capability-icon mb-2">ü§ñ</div>
                            <div class="fw-semibold">Zadaj pytanie, a Gaja znajdzie odpowied≈∫</div>
                            <small class="text-muted mt-1">Lokalne AI, kt√≥re rozumie Ciƒô i odpowiada jak cz≈Çowiek - bez chmury.</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="capability-card d-flex flex-column align-items-center text-center">
                            <div class="capability-icon mb-2">üéôÔ∏è</div>
                            <div class="fw-semibold">Sterowanie g≈Çosem i transkrypcja</div>
                            <small class="text-muted mt-1">M√≥w naturalnie - Gaja s≈Çucha, rozumie i dzia≈Ça. Nic nie musisz klikaƒá.</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="capability-card d-flex flex-column align-items-center text-center">
                            <div class="capability-icon mb-2">üîç</div>
                            <div class="fw-semibold">Wyszukiwanie informacji online</div>
                            <small class="text-muted mt-1">Pytasz - Gaja szuka, Ty masz odpowied≈∫. Szybko, konkretnie, bez reklamy.</small>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary btn-navigation prev-step">Wstecz</button>
                    <button class="btn btn-primary btn-navigation next-step">Dalej</button>
                </div>
            </div>
            <!-- Step 5: Completion -->
            <div class="step" id="step-5">
                <div class="completion-message">
                    <div class="completion-icon">‚úÖ</div>
                    <h2>Wszystko gotowe!</h2>
                    <p class="lead mb-4">Gaja zosta≈Ça pomy≈õlnie skonfigurowana.</p>
                    <p>Mo≈ºesz teraz korzystaƒá z Gai. Naci≈õnij przycisk, aby rozpoczƒÖƒá.</p>
                    <div class="mt-4">
                        <button id="finishBtn" class="btn btn-success btn-lg">Start</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        $(document).ready(function() {
            // Try to restore the last step from session storage if available
            let currentStep = parseInt(sessionStorage.getItem('onboardingStep')) || 1;
            const totalSteps = 5;
            
            // Initial display of the correct step
            showStep(currentStep);            // Function to show a specific step
            function showStep(stepNumber) {
                $('.step').removeClass('active');
                $('#step-' + stepNumber).addClass('active');
                
                // Update step dots
                $('.step-dot').removeClass('active');
                $('.step-dot[data-step="' + stepNumber + '"]').addClass('active');
                
                currentStep = stepNumber;
                
                // Save current step to session storage for potential page reload
                sessionStorage.setItem('onboardingStep', currentStep);
                // Trigger actions when entering specific steps
                if (currentStep === 2) {
                    loadMicrophoneDevices();
                }
                if (currentStep === 3) {
                    $('#providerSelect').trigger('change');
                }
            }

            // Handle provider change to display appropriate model and API key fields
            $('#providerSelect').on('change', function() {
                const provider = $(this).val();
                // Hide all provider fields by adding Bootstrap d-none class
                $('.api-key-field').addClass('d-none');
                // Show selected provider fields by removing d-none
                if (provider === 'openai') {
                    $('#openaiFields').removeClass('d-none');
                } else if (provider === 'azure') {
                    $('#azureFields').removeClass('d-none');
                } else if (provider === 'anthropic') {
                    $('#anthropicFields').removeClass('d-none');
                } else if (provider === 'deepseek') {
                    $('#deepseekFields').removeClass('d-none');
                } else if (provider === 'local') {
                    $('#localFields').removeClass('d-none');
                }
            });

            // Next button click
            $('.next-step').click(function() {
                if (currentStep < totalSteps) {
                    showStep(currentStep + 1);
                }
            });

            // Previous button click
            $('.prev-step').click(function() {
                if (currentStep > 1) {
                    showStep(currentStep - 1);
                }
            });

            // Step dot click
            $('.step-dot').click(function() {
                const stepNumber = $(this).data('step');
                showStep(stepNumber);
            });            // Try to load saved form data from localStorage
            function loadSavedFormData() {
                try {
                    const savedData = localStorage.getItem('onboardingFormData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        $('#userName').val(data.USER_NAME || '');
                        $('#assistantName').val(data.ASSISTANT_NAME || 'Gaja');
                        $('#mic-device-id-select').val(data.MIC_DEVICE_ID || '');
                        $('#language').val(data.LANGUAGE || 'pl-PL');
                        
                        // API keys for various providers
                        if (data.API_KEYS) {
                            $('#openaiKeyInput').val(data.API_KEYS.OPENAI_API_KEY || '');
                            $('#azureKeyInput').val(data.API_KEYS.AZURE_SPEECH_KEY || '');
                            $('#anthropicKeyInput').val(data.API_KEYS.ANTHROPIC_API_KEY || '');
                            $('#deepseekKeyInput').val(data.API_KEYS.DEEPSEEK_API_KEY || '');
                            $('#localAddressInput').val(data.API_KEYS.LOCAL_ENDPOINT || '');
                        }
                        // Provider and model/endpoint
                        if (data.PROVIDER) {
                            $('#providerSelect').val(data.PROVIDER);
                            $('#providerSelect').trigger('change');
                        }
                        if (data.MODEL) {
                            $('#openaiModelInput').val(data.MODEL);
                            $('#azureModelInput').val(data.MODEL);
                            $('#anthropicModelInput').val(data.MODEL);
                            $('#deepseekModelInput').val(data.MODEL);
                            $('#localAddressInput').val(data.MODEL);
                        }
                    }
                } catch (error) {
                    console.error('Error loading saved form data:', error);
                }
            }
            
            // Load any saved form data
            loadSavedFormData();
            
            // Save form data as user progresses through steps
            $('.next-step').click(function() {
                saveFormData();
            });
            
            function saveFormData() {
                // Collect form data including provider, model and keys
                const provider = $('#providerSelect').val();
                let model, endpoint;
                if (provider === 'openai') {
                    model = $('#openaiModelInput').val();
                    endpoint = $('#openaiKeyInput').val();
                } else if (provider === 'azure') {
                    model = $('#azureModelInput').val();
                    endpoint = $('#azureKeyInput').val();
                } else if (provider === 'anthropic') {
                    model = $('#anthropicModelInput').val();
                    endpoint = $('#anthropicKeyInput').val();
                } else if (provider === 'deepseek') {
                    model = $('#deepseekModelInput').val();
                    endpoint = $('#deepseekKeyInput').val();
                } else { // local
                    model = $('#localAddressInput').val();
                    endpoint = model;
                }                const formData = {
                    USER_NAME: $('#userName').val() || '',
                    ASSISTANT_NAME: $('#assistantName').val() || 'Gaja',
                    MIC_DEVICE_ID: $('#mic-device-id-select').val(),
                    LANGUAGE: $('#language').val() || 'pl-PL',
                    PROVIDER: provider,
                    MODEL: model,
                    API_KEYS: {
                        OPENAI_API_KEY: $('#openaiKeyInput').val() || '',
                        AZURE_SPEECH_KEY: $('#azureKeyInput').val() || '',
                        ANTHROPIC_API_KEY: $('#anthropicKeyInput').val() || '',
                        DEEPSEEK_API_KEY: $('#deepseekKeyInput').val() || '',
                        LOCAL_ENDPOINT: $('#localAddressInput').val() || ''
                    }
                };
                localStorage.setItem('onboardingFormData', JSON.stringify(formData));
            }            // Function to get user location based on IP
            function getUserLocation() {
                return new Promise((resolve) => {
                    // Try to get location from IP
                    $.ajax({
                        url: 'http://ip-api.com/json/',
                        method: 'GET',
                        timeout: 5000,
                        success: function(data) {
                            if (data && data.status === 'success') {
                                const location = `${data.city},${data.countryCode}`;
                                resolve(location);
                            } else {
                                resolve('Warsaw,PL'); // Default fallback
                            }
                        },
                        error: function() {
                            resolve('Warsaw,PL'); // Default fallback
                        }
                    });
                });
            }

            // Save settings and complete onboarding
            $('#finishBtn').click(async function() {
                // Get user location
                const userLocation = await getUserLocation();
                
                // Retrieve any saved intermediary form data
                const saved = JSON.parse(localStorage.getItem('onboardingFormData') || '{}');
                const config = {
                    USER_NAME: $('#userName').val() || saved.USER_NAME || '',
                    ASSISTANT_NAME: $('#assistantName').val() || saved.ASSISTANT_NAME || 'Gaja',
                    WAKE_WORD: $('#wakeWord').val() || 'gaja',
                    LANGUAGE: $('#language').val() || saved.LANGUAGE || 'pl-PL',
                    MIC_DEVICE_ID: parseInt($('#mic-device-id-select').val(), 10) || (saved.MIC_DEVICE_ID ? parseInt(saved.MIC_DEVICE_ID, 10) : null),
                    PROVIDER: $('#providerSelect').val() || saved.PROVIDER || 'openai',
                    MODEL: saved.MODEL || '',
                    API_KEYS: {
                        OPENAI_API_KEY: $('#openaiKeyInput').val() || (saved.API_KEYS && saved.API_KEYS.OPENAI_API_KEY) || '',
                        AZURE_SPEECH_KEY: $('#azureKeyInput').val() || (saved.API_KEYS && saved.API_KEYS.AZURE_SPEECH_KEY) || '',
                        AZURE_SPEECH_REGION: $('#azureRegion').val() || (saved.API_KEYS && saved.API_KEYS.AZURE_SPEECH_REGION) || '',                        ANTHROPIC_API_KEY: (saved.API_KEYS && saved.API_KEYS.ANTHROPIC_API_KEY) || '',
                        DEEPSEEK_API_KEY: (saved.API_KEYS && saved.API_KEYS.DEEPSEEK_API_KEY) || '',
                        LOCAL_ENDPOINT: (saved.API_KEYS && saved.API_KEYS.LOCAL_ENDPOINT) || ''
                    },
                    daily_briefing: {
                        enabled: true,
                        user_name: $('#userName').val() || saved.USER_NAME || '',
                        location: userLocation
                    }
                };

                // Save the configuration
                $.ajax({
                    url: '/api/config',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(config),
                    success: function() {                        // Mark onboarding as complete
                        $.ajax({
                            url: '/api/complete-onboarding',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(config),
                            success: function() {
                                // Clear session storage and local storage
                                sessionStorage.removeItem('onboardingStep');
                                localStorage.removeItem('onboardingFormData');
                                // Redirect to the main interface
                                window.location.href = '/';
                            },
                            error: function(error) {
                                console.error('Failed to complete onboarding:', error);
                                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas ko≈Ñczenia konfiguracji. Spr√≥buj ponownie.');
                            }
                        });
                    },
                    error: function(error) {
                        console.error('Failed to save configuration:', error);
                        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania konfiguracji. Spr√≥buj ponownie.');
                    }
                });
            });
            
            // Function to load available microphone devices with improved error handling
            function loadMicrophoneDevices() {
                const micSelect = $('#mic-device-id-select');
                const refreshBtn = $('#refresh-mic-devices-btn');
                
                // Display loading state
                micSelect.empty().append('<option value="">≈Åadowanie urzƒÖdze≈Ñ...</option>');
                refreshBtn.prop('disabled', true).find('i').addClass('fa-spin');
                
                $.ajax({
                    url: '/api/audio/microphones',
                    method: 'GET',
                    timeout: 8000, // 8 second timeout
                    success: function(data) {
                        micSelect.empty();
                        
                        if (!data || data.length === 0) {
                            micSelect.append('<option value="">Nie znaleziono mikrofon√≥w</option>');
                            return;
                        }
                        
                        let defaultSelected = false;
                        data.forEach(function(device) {
                            // Skip error entries
                            if (device.id === "-1") {
                                micSelect.append('<option value="">' + device.name + '</option>');
                                return;
                            }
                            
                            const option = $('<option></option>')
                                .attr('value', device.id)
                                .text(device.name);
                                
                            if (device.is_default && !defaultSelected) {
                                option.attr('selected', 'selected');
                                defaultSelected = true;
                            }
                            
                            micSelect.append(option);
                        });
                        
                        // If no default device was found, select the first one
                        if (!defaultSelected && data.length > 0 && data[0].id !== "-1") {
                            micSelect.find('option:first').attr('selected', 'selected');
                        }
                    },
                    error: function(error) {
                        console.error('Failed to load microphone devices:', error);
                        micSelect.empty().append('<option value="">B≈ÇƒÖd podczas ≈Çadowania urzƒÖdze≈Ñ</option>');
                    },
                    complete: function() {
                        // Reset loading state
                        refreshBtn.prop('disabled', false).find('i').removeClass('fa-spin');
                    }
                });
            }
        });
    </script>
</body>
</html>
