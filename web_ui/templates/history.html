{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Conversation History</h1>
        <button id="clear-history-btn" class="btn btn-danger btn-sm">
            <i class="fas fa-trash"></i> Clear History
        </button>
    </div>

    <div id="history-log" class="list-group">
        {% if history %}
            {% for entry in history %}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">
                            {% if entry.role == 'user' %}
                                <i class="fas fa-user text-primary me-2"></i>User
                            {% else %}
                                <i class="fas fa-robot text-success me-2"></i>Assistant
                            {% endif %}
                        </h5>
                        {# <small>Timestamp (TODO)</small> #}
                    </div>
                    <p class="mb-1">{{ entry.content }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No conversation history found.</p>
        {% endif %}
    </div>
     <span id="clear-status" class="ms-2 text-muted"></span>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const clearBtn = document.getElementById('clear-history-btn');
    const clearStatus = document.getElementById('clear-status');
    const historyLog = document.getElementById('history-log');

    clearBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear the entire conversation history? This action cannot be undone.')) {
            clearStatus.textContent = 'Clearing...';
            clearBtn.disabled = true;

            fetch('/api/history', {
                method: 'DELETE'
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    clearStatus.textContent = 'History cleared.';
                    historyLog.innerHTML = '<p class="text-muted">Conversation history cleared.</p>'; // Update UI
                } else {
                    clearStatus.textContent = `Error: ${body.error || 'Failed to clear.'}`;
                }
                 // Re-enable button after a short delay
                setTimeout(() => {
                    clearBtn.disabled = false;
                    clearStatus.textContent = '';
                }, 2000);
            })
            .catch(error => {
                console.error('Error clearing history:', error);
                clearStatus.textContent = 'Error sending request.';
                clearBtn.disabled = false;
            });
        }
    });
</script>
{% endblock %}
