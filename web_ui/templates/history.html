{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Conversation History</h1>
        <button id="clear-history-btn" class="btn btn-warning btn-sm">
            <i class="fas fa-archive"></i> Archive History
        </button>
    </div>

    <div id="history-log" class="list-group">
        {% if history %}
            {% for entry in history %}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">
                            {% if entry.role == 'user' %}
                                <i class="fas fa-user text-primary me-2"></i>User
                            {% else %}
                                <i class="fas fa-robot text-success me-2"></i>Assistant
                            {% endif %}
                        </h5>
                        {% if entry.timestamp %}
                            <small>{{ entry.timestamp }}</small>
                        {% endif %}
                    </div>
                    <p class="mb-1">{{ entry.content }}</p>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No conversation history found in the current log file.</p>
        {% endif %}
    </div>
     <span id="clear-status" class="ms-2 text-muted"></span>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const clearBtn = document.getElementById('clear-history-btn');
    const clearStatus = document.getElementById('clear-status');
    const historyLog = document.getElementById('history-log');

    clearBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to archive the current conversation history log? The current log will be moved to an archive folder.')) {
            clearStatus.textContent = 'Archiving...';
            clearStatus.className = 'ms-2 text-info';
            clearBtn.disabled = true;

            fetch('/api/history', {
                method: 'DELETE' // Still using DELETE method as per the API route
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    clearStatus.textContent = 'History archived successfully.';
                    clearStatus.className = 'ms-2 text-success';
                    historyLog.innerHTML = '<p class="text-muted">Conversation history archived. New log file started (refresh may be needed to see new entries).</p>'; // Update UI
                } else {
                    clearStatus.textContent = `Error: ${body.error || 'Failed to archive.'}`;
                    clearStatus.className = 'ms-2 text-danger';
                }
                 // Re-enable button after a short delay
                setTimeout(() => {
                    clearBtn.disabled = false;
                    clearStatus.textContent = '';
                }, 3000);
            })
            .catch(error => {
                console.error('Error archiving history:', error);
                clearStatus.textContent = 'Error sending request.';
                clearStatus.className = 'ms-2 text-danger';
                clearBtn.disabled = false;
                 setTimeout(() => {
                    clearStatus.textContent = '';
                }, 3000);
            });
        }
    });
</script>
{% endblock %}
