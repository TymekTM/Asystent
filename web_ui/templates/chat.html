{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatgpt.css') }}">
<div class="container mt-4" style="max-width: 700px;">
    <div class="card mb-3">
        <div id="chat-history" class="card-body overflow-auto" style="max-height: 60vh;"></div>
    </div>
    <form id="chat-form" class="mt-3 row gx-2 gy-2 flex-wrap align-items-stretch">
        <div class="col-12 col-md-7 d-flex mb-2 mb-md-0">
            <input type="text" class="form-control flex-grow-1" id="chat-input" placeholder="Napisz wiadomość..." autocomplete="off">
        </div>
        <div class="col-12 col-md-5 d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-primary w-100 w-md-auto">Wyślij</button>
            <button type="button" class="btn btn-secondary w-100 w-md-auto" id="voice-btn"><i class="fas fa-microphone"></i></button>
            <button type="button" class="btn btn-outline-danger w-100 w-md-auto" id="clear-chat-btn">Wyczyść</button>
            <button type="button" class="btn btn-primary w-100 w-md-auto" id="manual-activate-btn"><i class="fas fa-bolt"></i> Aktywuj asystenta</button>
            <button type="button" class="btn btn-success w-100 w-md-auto d-none" id="mobile-record-btn"><i class="fas fa-microphone"></i> Nagraj głos</button>
        </div>
    </form>
    <div id="manual-activate-status" class="mt-2"></div>
    <div id="chat-status" class="mt-2 text-info" style="min-height:24px;"></div>
</div>
<script>
// Insert assistant spinner bubble
function appendSpinner(role) {
    const chatHistory = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = `bubble ${role} d-flex align-items-center`;
    msgDiv.id = 'assistant-spinner';
    msgDiv.innerHTML = `<i class="fas fa-circle-notch fa-spin spinner"></i> <span>Asystent pracuje...</span>`;
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}
let recognizing = false;
let recognition;

function appendMessage(role, content, timestamp) {
    const chatHistory = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = `bubble ${role}`;
    let timeHtml = timestamp ? `<span class='text-muted small ms-2'>${timestamp}</span>` : '';
    msgDiv.innerHTML = `<span>${content}</span> ${timeHtml}`;
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function loadHistory() {
    fetch('/api/chat/history')
        .then(r => r.json())
        .then(data => {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = '';
            (data.history || []).forEach(msg => appendMessage(msg.role, msg.content, msg.timestamp));
        });
}

// Send message with streaming response
function sendMessage(text) {
    if (!text.trim()) return;
    // User bubble
    appendMessage('user', text, new Date().toLocaleTimeString());
    document.getElementById('chat-input').value = '';
    document.getElementById('chat-status').textContent = '';
    // Append spinner bubble for assistant
    appendSpinner('assistant');
    // Start EventSource stream
    const evtSource = new EventSource(`/api/chat/stream?message=${encodeURIComponent(text)}`);
    let fullReply = '';
    evtSource.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const spinner = document.getElementById('assistant-spinner');
        if (!spinner) return;
        if (data.type === 'tool') {
            // Update spinner to show tool invocation
            spinner.querySelector('span').textContent = data.content;
        } else if (data.type === 'tool_result') {
            // Display tool result in a distinct bubble
            const chatHistory = document.getElementById('chat-history');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'bubble tool';
            toolDiv.innerHTML = `<span>${data.content}</span>`;
            chatHistory.appendChild(toolDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        } else if (data.type === 'chunk') {
            fullReply += data.content;
            spinner.innerHTML = `<span>${fullReply}</span>`;
        } else if (data.type === 'final') {
            const timeHtml = `<span class='text-muted small ms-2'>${new Date().toLocaleTimeString()}</span>`;
            spinner.id = '';
            spinner.className = 'bubble assistant';
            spinner.innerHTML = `<span>${fullReply}</span> ${timeHtml}`;
            evtSource.close();
        }
    };
    evtSource.onerror = function() {
        evtSource.close();
        const spinner = document.getElementById('assistant-spinner');
        if (spinner) spinner.remove();
        document.getElementById('chat-status').textContent = 'Błąd komunikacji z AI.';
    };
}

document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    sendMessage(document.getElementById('chat-input').value);
};

// Voice input
const voiceBtn = document.getElementById('voice-btn');
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'pl-PL';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById('chat-input').value = text;
        sendMessage(text);
    };
    recognition.onend = function() { recognizing = false; voiceBtn.classList.remove('btn-danger'); };
    voiceBtn.onclick = function() {
        if (recognizing) { recognition.stop(); return; }
        recognition.start(); recognizing = true; voiceBtn.classList.add('btn-danger');
    };
} else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Brak wsparcia dla rozpoznawania mowy w tej przeglądarce';
}

document.getElementById('clear-chat-btn').onclick = function() {
    if (!confirm('Na pewno wyczyścić historię chatu?')) return;
    fetch('/api/chat/clear', { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) loadHistory(); });
};

// Manual Activation Button logic
const manualActivateBtn = document.getElementById('manual-activate-btn');
const manualActivateStatus = document.getElementById('manual-activate-status');
if (manualActivateBtn) {
    manualActivateBtn.addEventListener('click', () => {
        manualActivateStatus.textContent = 'Wysyłanie żądania aktywacji...';
        manualActivateStatus.className = 'ms-2 text-info';
        manualActivateBtn.disabled = true;
        fetch('/api/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status === 202 || status === 200) {
                manualActivateStatus.textContent = body.message || 'Aktywacja wysłana!';
                manualActivateStatus.className = 'ms-2 text-success';
            } else {
                manualActivateStatus.textContent = `Błąd: ${body.error || 'Nie udało się wysłać żądania.'}`;
                manualActivateStatus.className = 'ms-2 text-danger';
            }
            setTimeout(() => {
                manualActivateBtn.disabled = false;
                manualActivateStatus.textContent = '';
            }, 3000);
        })
        .catch(() => {
            manualActivateStatus.textContent = 'Błąd wysyłania żądania.';
            manualActivateStatus.className = 'ms-2 text-danger';
            manualActivateBtn.disabled = false;
            setTimeout(() => {
                manualActivateStatus.textContent = '';
            }, 3000);
        });
    });
}
// Keyboard shortcut: Ctrl+M for manual activation
window.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
        if (manualActivateBtn && !manualActivateBtn.disabled) {
            manualActivateBtn.click();
            e.preventDefault();
        }
    }
});

// Mobile microphone auto-activation
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

window.addEventListener('DOMContentLoaded', function() {
    if (isMobileDevice()) {
        // Spróbuj automatycznie uruchomić rozpoznawanie mowy na urządzeniu mobilnym
        const voiceBtn = document.getElementById('voice-btn');
        if (voiceBtn && typeof voiceBtn.click === 'function') {
            setTimeout(() => {
                voiceBtn.click();
            }, 700); // krótka zwłoka na załadowanie UI
        }
    }
});

const mobileRecordBtn = document.getElementById('mobile-record-btn');
if (isMobileDevice() && mobileRecordBtn) {
    mobileRecordBtn.classList.remove('d-none');
}

let mediaRecorder;
let audioChunks = [];

if (mobileRecordBtn) {
    mobileRecordBtn.addEventListener('click', async function() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'voice.webm');
                    // Wyślij do backendu
                    const statusDiv = document.getElementById('chat-status');
                    statusDiv.textContent = 'Wysyłanie nagrania...';
                    try {
                        const response = await fetch('/api/voice_upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.text) {
                            // Wyświetl rozpoznany tekst jako wiadomość użytkownika
                            appendMessage('user', data.text, new Date().toLocaleTimeString());
                            // Opcjonalnie: automatycznie wyślij do AI
                            sendMessage(data.text);
                        } else {
                            statusDiv.textContent = 'Brak rozpoznanego tekstu.';
                        }
                    } catch (e) {
                        statusDiv.textContent = 'Błąd wysyłania nagrania.';
                    }
                };
                mediaRecorder.start();
                mobileRecordBtn.textContent = 'Zatrzymaj nagrywanie';
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        mobileRecordBtn.textContent = 'Nagraj głos';
                    }
                }, 10000); // max 10s
            } catch (err) {
                alert('Brak dostępu do mikrofonu.');
            }
        } else if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mobileRecordBtn.textContent = 'Nagraj głos';
        }
    });
}

loadHistory();
</script>
{% block extra_css %}
<style>
@media (max-width: 600px) {
    #chat-history {
        font-size: 1.05em;
        min-height: 200px;
        max-height: 40vh;
        overflow-y: auto;
    }
    .bubble {
        font-size: 1em;
        padding: 0.7em 1em;
        word-break: break-word;
    }
    #chat-form .btn {
        font-size: 1em;
        padding: 0.7em 0.5em;
    }
}
#chat-history {
    min-height: 250px;
    max-height: 55vh;
    overflow-y: auto;
    margin-bottom: 1em;
}
.bubble {
    border-radius: 1em;
    margin-bottom: 0.5em;
    padding: 0.8em 1.2em;
    background: #f5f5f5;
    max-width: 90%;
    word-break: break-word;
}
.bubble.user {
    background: #d1e7dd;
    align-self: flex-end;
}
.bubble.assistant {
    background: #e2e3e5;
    align-self: flex-start;
}
</style>
{% endblock %}
{% endblock %}
