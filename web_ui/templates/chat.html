{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatgpt.css') }}">
<div class="container mt-4" style="max-width: 700px;">
    <div id="chat-history"></div>
    <form id="chat-form" class="mt-3">
        <input type="text" class="form-control flex-grow-1" id="chat-input" placeholder="Napisz wiadomość..." autocomplete="off">
        <button type="submit" class="btn btn-primary ms-2">Wyślij</button>
        <button type="button" class="btn btn-secondary ms-2" id="voice-btn"><i class="fas fa-microphone"></i></button>
        <button type="button" class="btn btn-outline-danger ms-2" id="clear-chat-btn">Wyczyść</button>
        <button type="button" class="btn btn-primary ms-2" id="manual-activate-btn"><i class="fas fa-bolt"></i> Aktywuj asystenta</button>
    </form>
    <div id="manual-activate-status" class="mt-2"></div>
    <div id="chat-status" class="mt-2"></div>
</div>
<script>
let recognizing = false;
let recognition;

function appendMessage(role, content, timestamp) {
    const chatHistory = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = `bubble ${role}`;
    let timeHtml = timestamp ? `<span class='text-muted small ms-2'>${timestamp}</span>` : '';
    msgDiv.innerHTML = `<span>${content}</span> ${timeHtml}`;
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function loadHistory() {
    fetch('/api/chat/history')
        .then(r => r.json())
        .then(data => {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = '';
            (data.history || []).forEach(msg => appendMessage(msg.role, msg.content, msg.timestamp));
        });
}

function sendMessage(text) {
    if (!text.trim()) return;
    appendMessage('user', text, new Date().toLocaleTimeString());
    document.getElementById('chat-input').value = '';
    document.getElementById('chat-status').textContent = 'AI myśli...';
    fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
    })
    .then(r => r.json())
    .then(data => {
        appendMessage('assistant', data.reply, new Date().toLocaleTimeString());
        document.getElementById('chat-status').textContent = '';
    })
    .catch(() => {
        document.getElementById('chat-status').textContent = 'Błąd komunikacji z AI.';
    });
}

document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    sendMessage(document.getElementById('chat-input').value);
};

// Voice input
const voiceBtn = document.getElementById('voice-btn');
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'pl-PL';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById('chat-input').value = text;
        sendMessage(text);
    };
    recognition.onend = function() { recognizing = false; voiceBtn.classList.remove('btn-danger'); };
    voiceBtn.onclick = function() {
        if (recognizing) { recognition.stop(); return; }
        recognition.start(); recognizing = true; voiceBtn.classList.add('btn-danger');
    };
} else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Brak wsparcia dla rozpoznawania mowy w tej przeglądarce';
}

document.getElementById('clear-chat-btn').onclick = function() {
    if (!confirm('Na pewno wyczyścić historię chatu?')) return;
    fetch('/api/chat/clear', { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) loadHistory(); });
};

// Manual Activation Button logic
const manualActivateBtn = document.getElementById('manual-activate-btn');
const manualActivateStatus = document.getElementById('manual-activate-status');
if (manualActivateBtn) {
    manualActivateBtn.addEventListener('click', () => {
        manualActivateStatus.textContent = 'Wysyłanie żądania aktywacji...';
        manualActivateStatus.className = 'ms-2 text-info';
        manualActivateBtn.disabled = true;
        fetch('/api/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status === 202 || status === 200) {
                manualActivateStatus.textContent = body.message || 'Aktywacja wysłana!';
                manualActivateStatus.className = 'ms-2 text-success';
            } else {
                manualActivateStatus.textContent = `Błąd: ${body.error || 'Nie udało się wysłać żądania.'}`;
                manualActivateStatus.className = 'ms-2 text-danger';
            }
            setTimeout(() => {
                manualActivateBtn.disabled = false;
                manualActivateStatus.textContent = '';
            }, 3000);
        })
        .catch(() => {
            manualActivateStatus.textContent = 'Błąd wysyłania żądania.';
            manualActivateStatus.className = 'ms-2 text-danger';
            manualActivateBtn.disabled = false;
            setTimeout(() => {
                manualActivateStatus.textContent = '';
            }, 3000);
        });
    });
}
// Keyboard shortcut: Ctrl+M for manual activation
window.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
        if (manualActivateBtn && !manualActivateBtn.disabled) {
            manualActivateBtn.click();
            e.preventDefault();
        }
    }
});

loadHistory();
</script>
{% endblock %}
