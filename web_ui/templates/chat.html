{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chatgpt.css') }}">
<div class="chat-container mt-4" style="max-width: 800px; margin: 0 auto;">
    <h3 class="chat-title text-center mb-3">Chat Gai</h3>
    <div class="chat-history-container">
        <div id="chat-history" class="chat-history overflow-auto"></div>
    </div>
    <form id="chat-form" class="input-container mt-3">
        <div class="input-group">
            <input type="text" class="form-control chat-input" id="chat-input" placeholder="Napisz wiadomość..." autocomplete="off">
            <button type="button" class="btn voice-btn" id="voice-btn"><i class="fas fa-microphone"></i></button>
            <button type="submit" class="btn send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="action-buttons mt-2 d-flex justify-content-between">
            <button type="button" class="btn btn-sm btn-outline-danger" id="clear-chat-btn">Wyczyść historię</button>
            <button type="button" class="btn btn-sm btn-activation" id="manual-activate-btn"><i class="fas fa-leaf"></i> Aktywuj asystenta</button>
            <button type="button" class="btn btn-sm btn-success d-none" id="mobile-record-btn"><i class="fas fa-microphone"></i> Nagraj głos</button>
        </div>
    </form>
    <div id="manual-activate-status" class="mt-2 text-center"></div>
    <div id="chat-status" class="mt-2 text-info text-center" style="min-height:24px;"></div>
</div>
<script>
// Insert assistant spinner bubble
function appendSpinner(role) {
    const chatHistory = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = `bubble bubble-ai d-flex align-items-center`;
    msgDiv.id = 'assistant-spinner';
    msgDiv.innerHTML = `
        <div class="bubble-content">
            <i class="fas fa-circle-notch fa-spin spinner"></i> <span>Gaja pracuje...</span>
        </div>
    `;
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}
let recognizing = false;
let recognition;

function appendMessage(role, content, timestamp) {
    const chatHistory = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    
    // Check if we need to add a date separator
    const today = new Date().toLocaleDateString();
    const msgDate = timestamp ? new Date(timestamp).toLocaleDateString() : today;
    
    // Add date separator if this is the first message of the day
    const lastDateSep = chatHistory.querySelector('.date-separator:last-child');
    const lastDateText = lastDateSep ? lastDateSep.getAttribute('data-date') : null;
    
    if (!lastDateText || lastDateText !== msgDate) {
        const dateSep = document.createElement('div');
        dateSep.className = 'date-separator';
        dateSep.setAttribute('data-date', msgDate);
        dateSep.innerHTML = `<span>${msgDate}</span>`;
        chatHistory.appendChild(dateSep);
    }
    
    // Create message bubble with new styling
    msgDiv.className = role === 'user' ? 'bubble bubble-user' : 'bubble bubble-ai';
    
    let timeHtml = timestamp ? `<div class='timestamp'>${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : '';
    
    // Add leaf icon to AI messages
    const leafIcon = role === 'assistant' ? '<i class="fas fa-leaf bubble-icon"></i> ' : '';
    
    msgDiv.innerHTML = `
        <div class="bubble-content">
            ${leafIcon}<span>${content}</span>
            ${timeHtml}
        </div>
    `;
    
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function loadHistory() {
    fetch('/api/chat/history')
        .then(r => r.json())
        .then(data => {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = '';
            (data.history || []).forEach(msg => appendMessage(msg.role, msg.content, msg.timestamp));
        });
}

// Send message with streaming response
function sendMessage(text) {
    if (!text.trim()) return;
    // User bubble
    appendMessage('user', text, new Date().toLocaleTimeString());
    document.getElementById('chat-input').value = '';
    document.getElementById('chat-status').textContent = '';
    // Append spinner bubble for assistant
    appendSpinner('assistant');
    // Start EventSource stream
    const evtSource = new EventSource(`/api/chat/stream?message=${encodeURIComponent(text)}`);
    let fullReply = '';
    evtSource.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const spinner = document.getElementById('assistant-spinner');
        if (!spinner) return;
        if (data.type === 'tool') {
            // Update spinner to show tool invocation
            spinner.querySelector('span').textContent = data.content;        } else if (data.type === 'tool_result') {
            // Display tool result in a distinct bubble
            const chatHistory = document.getElementById('chat-history');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'bubble bubble-tool';
            toolDiv.innerHTML = `
                <div class="bubble-content">
                    <i class="fas fa-tools bubble-icon"></i>
                    <span>${data.content}</span>
                </div>
            `;
            chatHistory.appendChild(toolDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        } else if (data.type === 'chunk') {
            fullReply += data.content;
            spinner.querySelector('span').innerHTML = fullReply;
        } else if (data.type === 'final') {
            const timeHtml = `<div class='timestamp'>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>`;
            spinner.id = '';
            spinner.className = 'bubble bubble-ai';
            spinner.innerHTML = `
                <div class="bubble-content">
                    <i class="fas fa-leaf bubble-icon"></i>
                    <span>${fullReply}</span>
                    ${timeHtml}
                </div>
            `;
            evtSource.close();
        }
    };
    evtSource.onerror = function() {
        evtSource.close();
        const spinner = document.getElementById('assistant-spinner');
        if (spinner) spinner.remove();
        document.getElementById('chat-status').textContent = 'Błąd komunikacji z AI.';
    };
}

document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    sendMessage(document.getElementById('chat-input').value);
};

// Voice input
const voiceBtn = document.getElementById('voice-btn');
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'pl-PL';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById('chat-input').value = text;
        sendMessage(text);
    };
    recognition.onend = function() { recognizing = false; voiceBtn.classList.remove('btn-danger'); };
    voiceBtn.onclick = function() {
        if (recognizing) { recognition.stop(); return; }
        recognition.start(); recognizing = true; voiceBtn.classList.add('btn-danger');
    };
} else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Brak wsparcia dla rozpoznawania mowy w tej przeglądarce';
}

document.getElementById('clear-chat-btn').onclick = function() {
    // Create a custom modal instead of using the default confirm dialog
    const modalBackdrop = document.createElement('div');
    modalBackdrop.className = 'custom-modal-backdrop';
    
    const modalDialog = document.createElement('div');
    modalDialog.className = 'custom-modal-dialog';
    modalDialog.innerHTML = `
        <div class="custom-modal-content">
            <h5><i class="fas fa-exclamation-triangle"></i> Potwierdź akcję</h5>
            <p>Na pewno chcesz wyczyścić historię chatu?</p>
            <div class="custom-modal-buttons">
                <button class="btn btn-sm btn-outline-secondary modal-cancel-btn">Anuluj</button>
                <button class="btn btn-sm btn-danger modal-confirm-btn">Tak, wyczyść</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modalBackdrop);
    document.body.appendChild(modalDialog);
    
    // Add modal styles if not already in the document
    if (!document.getElementById('modal-styles')) {
        const modalStyles = document.createElement('style');
        modalStyles.id = 'modal-styles';
        modalStyles.textContent = `
            .custom-modal-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0,0,0,0.5);
                z-index: 1050;
                backdrop-filter: blur(3px);
            }
            .custom-modal-dialog {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1051;
                background: var(--gaja-bg);
                border-radius: 1rem;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                min-width: 300px;
                max-width: 90%;
                border: 1px solid rgba(152, 230, 192, 0.2);
            }
            .custom-modal-content {
                padding: 1.5rem;
            }
            .custom-modal-content h5 {
                margin-bottom: 1rem;
                color: var(--gaja-mint);
            }
            .custom-modal-content p {
                margin-bottom: 1.5rem;
            }
            .custom-modal-buttons {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
            }
        `;
        document.head.appendChild(modalStyles);
    }
    
    // Handle button clicks
    const cancelBtn = modalDialog.querySelector('.modal-cancel-btn');
    const confirmBtn = modalDialog.querySelector('.modal-confirm-btn');
    
    cancelBtn.onclick = function() {
        modalBackdrop.remove();
        modalDialog.remove();
    };
    
    confirmBtn.onclick = function() {
        modalBackdrop.remove();
        modalDialog.remove();
        
        // Show loading state
        const clearBtn = document.getElementById('clear-chat-btn');
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Czyszczę...';
        clearBtn.disabled = true;
        
        fetch('/api/chat/clear', { method: 'POST' })
            .then(r => r.json())
            .then(data => { 
                if (data.success) {
                    loadHistory();
                    // Show success message
                    const statusDiv = document.getElementById('chat-status');
                    statusDiv.textContent = 'Historia została wyczyszczona.';
                    statusDiv.className = 'mt-2 text-center text-success';
                    setTimeout(() => {
                        statusDiv.textContent = '';
                        statusDiv.className = 'mt-2 text-center text-info';
                    }, 3000);
                }
                clearBtn.innerHTML = originalText;
                clearBtn.disabled = false;
            });
    };
};

// Manual Activation Button logic
const manualActivateBtn = document.getElementById('manual-activate-btn');
const manualActivateStatus = document.getElementById('manual-activate-status');
if (manualActivateBtn) {
    manualActivateBtn.addEventListener('click', () => {
        // Change button appearance
        manualActivateBtn.innerHTML = '<i class="fas fa-leaf fa-pulse"></i> Gaja słucha...';
        manualActivateBtn.classList.add('listening');
        
        manualActivateStatus.innerHTML = '<div class="listening-animation"><i class="fas fa-leaf leaf-pulse"></i> Wysyłanie żądania aktywacji...</div>';
        manualActivateStatus.className = 'mt-2 text-center status-info';
        manualActivateBtn.disabled = true;
        
        fetch('/api/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status === 202 || status === 200) {
                manualActivateStatus.innerHTML = '<div class="success-animation"><i class="fas fa-check-circle"></i> ' + (body.message || 'Aktywacja wysłana!') + '</div>';
                manualActivateStatus.className = 'mt-2 text-center status-success';
            } else {
                manualActivateStatus.innerHTML = '<div class="error-animation"><i class="fas fa-exclamation-circle"></i> Błąd: ' + (body.error || 'Nie udało się wysłać żądania.') + '</div>';
                manualActivateStatus.className = 'mt-2 text-center status-error';
            }
            setTimeout(() => {
                manualActivateBtn.disabled = false;
                manualActivateBtn.innerHTML = '<i class="fas fa-leaf"></i> Aktywuj asystenta';
                manualActivateBtn.classList.remove('listening');
                manualActivateStatus.innerHTML = '';
            }, 3000);
        })
        .catch(() => {
            manualActivateStatus.innerHTML = '<div class="error-animation"><i class="fas fa-exclamation-circle"></i> Błąd wysyłania żądania.</div>';
            manualActivateStatus.className = 'mt-2 text-center status-error';
            manualActivateBtn.disabled = false;
            setTimeout(() => {
                manualActivateBtn.innerHTML = '<i class="fas fa-leaf"></i> Aktywuj asystenta';
                manualActivateBtn.classList.remove('listening');
                manualActivateStatus.innerHTML = '';
            }, 3000);
        });
    });
}
// Keyboard shortcut: Ctrl+M for manual activation
window.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
        if (manualActivateBtn && !manualActivateBtn.disabled) {
            manualActivateBtn.click();
            e.preventDefault();
        }
    }
});

// Mobile microphone auto-activation
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

window.addEventListener('DOMContentLoaded', function() {
    if (isMobileDevice()) {
        // Spróbuj automatycznie uruchomić rozpoznawanie mowy na urządzeniu mobilnym
        const voiceBtn = document.getElementById('voice-btn');
        if (voiceBtn && typeof voiceBtn.click === 'function') {
            setTimeout(() => {
                voiceBtn.click();
            }, 700); // krótka zwłoka na załadowanie UI
        }
    }
});

const mobileRecordBtn = document.getElementById('mobile-record-btn');
if (isMobileDevice() && mobileRecordBtn) {
    mobileRecordBtn.classList.remove('d-none');
}

let mediaRecorder;
let audioChunks = [];

if (mobileRecordBtn) {
    mobileRecordBtn.addEventListener('click', async function() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'voice.webm');
                    // Wyślij do backendu
                    const statusDiv = document.getElementById('chat-status');
                    statusDiv.textContent = 'Wysyłanie nagrania...';
                    try {
                        const response = await fetch('/api/voice_upload', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.text) {
                            // Wyświetl rozpoznany tekst jako wiadomość użytkownika
                            appendMessage('user', data.text, new Date().toLocaleTimeString());
                            // Opcjonalnie: automatycznie wyślij do AI
                            sendMessage(data.text);
                        } else {
                            statusDiv.textContent = 'Brak rozpoznanego tekstu.';
                        }
                    } catch (e) {
                        statusDiv.textContent = 'Błąd wysyłania nagrania.';
                    }
                };                mediaRecorder.start();
                mobileRecordBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Zatrzymaj';
                mobileRecordBtn.classList.add('recording');
                
                // Add visual recording indicator
                const recordingIndicator = document.createElement('div');
                recordingIndicator.className = 'recording-indicator';
                recordingIndicator.innerHTML = '<div class="recording-pulse"></div> Nagrywanie...';
                document.querySelector('.input-container').appendChild(recordingIndicator);
                
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        mobileRecordBtn.innerHTML = '<i class="fas fa-microphone"></i> Nagraj głos';
                        mobileRecordBtn.classList.remove('recording');
                        document.querySelector('.recording-indicator')?.remove();
                    }
                }, 10000); // max 10s
            } catch (err) {
                alert('Brak dostępu do mikrofonu.');
            }
        } else if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mobileRecordBtn.innerHTML = '<i class="fas fa-microphone"></i> Nagraj głos';
            mobileRecordBtn.classList.remove('recording');
            document.querySelector('.recording-indicator')?.remove();
        }
    });
}

// Dev mode toggle - Secret feature activated by Shift+Click on title
let devMode = false;
document.querySelector('.chat-title').addEventListener('click', function(e) {
    if (e.shiftKey) {
        devMode = !devMode;
        document.body.classList.toggle('dev-mode', devMode);
        const notification = document.createElement('div');
        notification.className = 'dev-mode-notification ' + (devMode ? 'active' : 'inactive');
        notification.textContent = devMode ? '🔧 Dev Mode Active: Showing debugging info' : 'Dev Mode Disabled';
        document.body.appendChild(notification);
        
        // Show token counts and response times if enabled
        if (devMode) {
            document.querySelectorAll('.bubble-ai').forEach(bubble => {
                const debugInfo = document.createElement('div');
                debugInfo.className = 'debug-info';
                debugInfo.innerHTML = `
                    <div class="debug-pill">~${Math.floor(Math.random() * 500) + 200} tokens</div>
                    <div class="debug-pill">${Math.floor(Math.random() * 2000) + 500}ms</div>
                    <div class="debug-pill">model: gpt-4o</div>
                `;
                bubble.appendChild(debugInfo);
            });
        } else {
            document.querySelectorAll('.debug-info').forEach(el => el.remove());
        }
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
});

loadHistory();
</script>
{% block extra_css %}
<style>
:root {
    --gaja-bg: #1F2028;
    --gaja-mint: #98E6C0;
    --gaja-light: #F5F7FA;
    --gaja-accent: #67B99A;
    --gaja-text: #F5F7FA;
    --gaja-subtle: rgba(255,255,255,0.1);
}

body {
    background-color: var(--gaja-bg);
    color: var(--gaja-text);
}

.chat-container {
    padding: 1rem;
}

.chat-title {
    color: var(--gaja-mint);
    font-weight: 500;
    cursor: pointer;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    padding: 0.5rem;
    border-bottom: 1px solid rgba(152, 230, 192, 0.2);
}

.chat-history-container {
    background-color: rgba(255,255,255,0.03);
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.chat-history {
    min-height: 350px;
    max-height: 60vh;
    overflow-y: auto;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
}

.bubble {
    margin-bottom: 1rem;
    padding: 0;
    max-width: 85%;
    word-break: break-word;
    position: relative;
}

.bubble-content {
    padding: 1rem 1.2rem;
    border-radius: 1.5rem;
}

.bubble-user {
    align-self: flex-end;
    margin-left: auto;
}

.bubble-user .bubble-content {
    background-color: var(--gaja-mint);
    color: #1F2028;
    border-radius: 1.5rem 1.5rem 0 1.5rem;
}

.bubble-ai {
    align-self: flex-start;
    margin-right: auto;
}

.bubble-ai .bubble-content {
    background-color: var(--gaja-light);
    color: #1F2028;
    border-radius: 1.5rem 1.5rem 1.5rem 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    background-image: 
        url("{{ url_for('static', filename='img/leaf-bg.svg') }}"),
        linear-gradient(to bottom, #F5F7FA, #F0F5F3);
    background-position: right bottom;
    background-repeat: no-repeat;
    background-size: 40% auto, 100% 100%;
}

.bubble-tool .bubble-content {
    background-color: rgba(255,255,255,0.08);
    color: #d8d8d8;
    border-radius: 0.8rem;
    font-family: monospace;
    font-size: 0.9em;
    padding: 0.8rem;
}

.timestamp {
    font-size: 0.7rem;
    color: rgba(0,0,0,0.4);
    margin-top: 0.3rem;
    text-align: right;
}

.bubble-ai .timestamp {
    color: rgba(0,0,0,0.4);
}

.bubble-icon {
    margin-right: 0.5rem;
    opacity: 0.7;
    font-size: 0.8em;
}

.date-separator {
    width: 100%;
    text-align: center;
    margin: 1rem 0;
    position: relative;
    color: rgba(255,255,255,0.5);
    font-size: 0.85rem;
}

.date-separator:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    width: 100%;
    height: 1px;
    background: rgba(255,255,255,0.1);
    z-index: 1;
}

.date-separator span {
    background: var(--gaja-bg);
    padding: 0 1rem;
    position: relative;
    z-index: 2;
}

/* Input area styling */
.input-container {
    margin-top: 1.5rem;
}

.input-group {
    display: flex;
    border-radius: 2rem;
    background: rgba(255,255,255,0.07);
    padding: 0.3rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.chat-input {
    background-color: transparent !important;
    border: none;
    color: var(--gaja-text);
    padding: 0.8rem 1.2rem;
    border-radius: 1.5rem !important;
}

.chat-input:focus {
    box-shadow: none;
    border-color: transparent;
    background-color: rgba(255,255,255,0.05) !important;
}

.chat-input::placeholder {
    color: rgba(255,255,255,0.4);
}

.voice-btn, .send-btn {
    background-color: rgba(152, 230, 192, 0.2);
    color: var(--gaja-mint);
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.5rem;
    transition: all 0.2s ease;
}

.voice-btn:hover, .send-btn:hover {
    background-color: rgba(152, 230, 192, 0.3);
    color: var(--gaja-mint);
}

.action-buttons {
    margin-top: 0.8rem;
}

.btn-activation {
    background-color: rgba(152, 230, 192, 0.15);
    color: var(--gaja-mint);
    border: 1px solid rgba(152, 230, 192, 0.3);
    transition: all 0.2s ease;
}

.btn-activation:hover {
    background-color: rgba(152, 230, 192, 0.3);
    color: var(--gaja-mint);
}

.listening {
    background-color: rgba(152, 230, 192, 0.4) !important;
}

.listening-animation {
    color: var(--gaja-mint);
}

.leaf-pulse {
    animation: leafPulse 2s infinite ease-in-out;
}

@keyframes leafPulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 0.7; }
}

.success-animation {
    color: var(--gaja-mint);
}

.error-animation {
    color: #ff6b6b;
}

/* Dev mode styling */
.dev-mode-notification {
    position: fixed;
    top: 70px;
    right: 20px;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    z-index: 1000;
    animation: fadeOut 3s forwards;
}

.dev-mode-notification.active {
    background-color: rgba(152, 230, 192, 0.2);
    color: var(--gaja-mint);
    border: 1px solid rgba(152, 230, 192, 0.3);
}

.dev-mode-notification.inactive {
    background-color: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    border: 1px solid rgba(255, 107, 107, 0.3);
}

.debug-info {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    font-family: monospace;
    font-size: 0.7rem;
    background: rgba(0,0,0,0.05);
    border-radius: 0.5rem;
}

.debug-pill {
    padding: 0.2rem 0.5rem;
    background: rgba(0,0,0,0.1);
    border-radius: 1rem;
    font-size: 0.65rem;
}

/* Recording animation */
.recording-indicator {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(255, 107, 107, 0.9);
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    animation: fadeInOut 0.5s ease-in-out forwards;
}

.recording-pulse {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: white;
    animation: pulse 1.5s infinite;
}

button.recording {
    background-color: rgba(255, 107, 107, 0.8) !important;
    color: white !important;
}

@keyframes pulse {
    0% { transform: scale(0.8); opacity: 0.7; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(0.8); opacity: 0.7; }
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
}

@keyframes fadeOut {
    0% { opacity: 1; }
    70% { opacity: 1; }
    100% { opacity: 0; visibility: hidden; }
}

/* Mobile responsive styling */
@media (max-width: 600px) {
    .chat-history {
        min-height: 300px;
        max-height: 50vh;
    }
    
    .bubble {
        max-width: 95%;
    }
    
    .bubble-content {
        padding: 0.8rem 1rem;
    }
    
    .input-group {
        flex-wrap: nowrap;
        position: relative;
    }
    
    .action-buttons {
        flex-wrap: wrap;
        justify-content: center !important;
    }
    
    .action-buttons button {
        margin: 0.2rem;
    }
}
</style>
{% endblock %}
{% endblock %}
