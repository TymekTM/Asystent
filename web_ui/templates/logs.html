<!-- filepath: f:\Asystent\web_ui\templates\logs.html.new -->
{% extends "base.html" %}

{% block head_extra %}
<style>
.log-entry {
  font-family: monospace;
  font-size: 0.875rem;
  line-height: 1.4;
  padding: 0.3rem 1rem;
  border-left: 4px solid;
  margin-bottom: 2px;
  transition: all 0.2s ease;
}

.log-entry:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.log-entry.INFO { border-color: #98E6C0; }
.log-entry.ERROR { border-color: #F76B6B; background-color: rgba(247, 107, 107, 0.1); color: #f0f0f0; }
.log-entry.WARNING { border-color: #FFD166; background-color: rgba(255, 209, 102, 0.1); }
.log-entry.DEBUG { border-color: #B0D9E8; background-color: rgba(176, 217, 232, 0.1); }

.log-timestamp {
  color: #888;
  font-size: 0.8rem;
  margin-right: 1rem;
  display: inline-block;
  min-width: 180px;
}

.log-level {
  font-weight: bold;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  text-transform: uppercase;
  margin-right: 1rem;
  display: inline-block;
  min-width: 60px;
  text-align: center;
}

.level-INFO { background-color: #98E6C0; color: #333; }
.level-ERROR { background-color: #F76B6B; color: white; }
.level-WARNING { background-color: #FFD166; color: #333; }
.level-DEBUG { background-color: #B0D9E8; color: #333; }

.log-container {
  background-color: #1e1e1e;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  height: 600px;
  overflow-y: auto;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.log-toolbar {
  background-color: #2a2a2a;
  padding: 0.8rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #444;
}

.log-filters {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.timeline-connector {
  position: relative;
}

.timeline-connector::before {
  content: "";
  position: absolute;
  top: 0;
  left: 2px;
  height: 100%;
  width: 2px;
  background-color: #444;
  z-index: -1;
}

.timeline-hour {
  position: relative;
  padding-left: 15px;
  margin: 20px 0 10px;
  color: #98E6C0;
  font-weight: bold;
}

.timeline-hour::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #98E6C0;
  transform: translateY(-50%);
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üßæ Logi systemowe</h1>
        <p class="text-muted">Monitorowanie proces√≥w AI i systemu</p>
    </div>
    
    <div class="log-toolbar mb-3">
        <div class="log-filters">
            <select id="log-level" class="form-select form-select-sm">
                <option value="ALL">Wszystkie poziomy</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
                <option value="DEBUG">DEBUG</option>
            </select>
            <button class="btn btn-sm btn-outline-light" onclick="filterLogs()">
                <i class="fas fa-sync-alt me-1"></i> Od≈õwie≈º
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="downloadLogs()">
                <i class="fas fa-download me-1"></i> Pobierz logi
            </button>
        </div>
        <div class="pagination">
            <button class="btn btn-sm btn-outline-light" id="prev-page" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="page-info" class="text-light px-2">Strona 1 z 1</span>
            <button class="btn btn-sm btn-outline-light" id="next-page" onclick="changePage(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="log-container timeline-connector">
        <div id="logs-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
const pageSize = 100;

function formatLogEntry(logEntry) {
    // Extract timestamp, level and message using regex
    const regex = /\[(.*?)\]\s+(\w+)\s+(.*)/;
    const match = logEntry.match(regex);
    
    if (match) {
        const timestamp = match[1];
        const level = match[2];
        const message = match[3];
        
        // Get hour from timestamp to create timeline sections
        const hourMatch = timestamp.match(/\d{2}:\d{2}/);
        const timeHour = hourMatch ? hourMatch[0] : null;
        
        return {
            formattedEntry: `<div class="log-entry ${level}">
                                <span class="log-timestamp">${timestamp}</span>
                                <span class="log-level level-${level}">${level}</span>
                                <span class="log-message">${message}</span>
                            </div>`,
            timeHour: timeHour
        };
    } else {
        return {
            formattedEntry: `<div class="log-entry">${logEntry}</div>`,
            timeHour: null
        };
    }
}

function filterLogs(page = 1) {
    document.getElementById('logs-content').innerHTML = `
        <div class="d-flex justify-content-center p-5">
            <div class="spinner-border text-light" role="status"></div>
        </div>`;
    
    const level = document.getElementById('log-level').value;
    fetch(`/api/logs?level=${level}&page=${page}&page_size=${pageSize}`)
        .then(res => res.json())
        .then(data => {
            if (!data.logs || data.logs.length === 0) {
                document.getElementById('logs-content').innerHTML = 
                    '<div class="p-4 text-center text-light">Brak log√≥w do wy≈õwietlenia</div>';
                return;
            }
            
            // Process logs to create timeline sections
            let currentHour = null;
            let html = '';
            
            data.logs.forEach(logEntry => {
                const {formattedEntry, timeHour} = formatLogEntry(logEntry);
                
                // Add hour divider when hour changes
                if (timeHour && timeHour !== currentHour) {
                    currentHour = timeHour;
                    html += `<div class="timeline-hour">${timeHour}</div>`;
                }
                
                html += formattedEntry;
            });
            
            document.getElementById('logs-content').innerHTML = html;
            
            // Update pagination info
            currentPage = data.page;
            totalPages = data.total_pages;
            document.getElementById('page-info').textContent = `Strona ${currentPage} z ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        })
        .catch(err => {
            document.getElementById('logs-content').innerHTML = 
                `<div class="p-4 text-center text-danger">B≈ÇƒÖd ≈Çadowania log√≥w: ${err.message}</div>`;
        });
}

function changePage(delta) {
    let newPage = currentPage + delta;
    if (newPage < 1) newPage = 1;
    if (newPage > totalPages) newPage = totalPages;
    filterLogs(newPage);
}

function downloadLogs() {
    window.location.href = '/api/logs/download';
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('log-level').addEventListener('change', () => filterLogs(1));
    
    // Initial logs load
    filterLogs(1);
    
    // Set up auto-refresh every 30 seconds
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            filterLogs(currentPage);
        }
    }, 30000);
});
</script>
{% endblock %}
