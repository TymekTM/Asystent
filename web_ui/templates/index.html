{% extends "base.html" %}

{# Define default values for stats if not provided #}
{% set stats = stats or {
    "message_count": 243,  
    "avg_response_time": "1.2",
    "today_queries": 14,
    "last_query": "Jaka bƒôdzie pogoda na jutro?"
} %}

{% set recent_messages = recent_messages or [
    {"sender": "user", "content": "Dzie≈Ñ dobry Gaja, jaka jest pogoda na dzi≈õ?", "timestamp": "10:23"},
    {"sender": "assistant", "content": "Dzie≈Ñ dobry! Dzi≈õ w Twojej lokalizacji bƒôdzie s≈Çonecznie, temperatura 22¬∞C. Idealna pogoda na spacer!", "timestamp": "10:24"}
] %}

{% block content %}
<div class="container mt-4">
    <!-- Dashboard Header with Welcome Message -->
    <div class="gaja-welcome">
        <h1>Dzie≈Ñ dobry, {{ session.username }} üåû</h1>
        <p>Jestem Gaja. Co dzi≈õ razem zrobimy?</p>
    </div>

    <!-- Dashboard Grid Layout -->
    <div class="dashboard-grid">
        <!-- Left Column: Status & Actions -->
        <div>
            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Status Gai
                </div>
                <div class="card-body">
                    <div class="status-item">
                        <span class="status-indicator {% if status.get('status') == 'Online' %}online{% else %}offline{% endif %}"></span>
                        <span class="status-label">Status:</span>
                        <span id="assistant-status-badge" class="badge {% if status.get('status') == 'Online' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ status.get('status', 'Unknown') }}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Wake Word:</span>
                        <span class="badge" style="background-color: var(--gaja-blue)">{{ config.get('WAKE_WORD', 'N/A') }}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator {% if status.get('microphone') %}online{% else %}offline{% endif %}"></span>
                        <span class="status-label">Mikrofon:</span>
                        <span class="badge {% if status.get('microphone') %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'ON' if status.get('microphone') else 'OFF' }}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator online"></span>
                        <span class="status-label">Internet:</span>
                        <span class="badge bg-success">OK</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>Szybkie akcje
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button id="manual-activate-btn" class="btn btn-gaja">
                            <i class="fas fa-microphone"></i> Aktywuj mikrofon
                        </button>
                        <button id="restart-assistant-btn" class="btn btn-gaja btn-gaja-primary">
                            <i class="fas fa-sync-alt"></i> Restart Gai
                        </button>
                        <button id="stop-assistant-btn" class="btn btn-gaja btn-gaja-danger">
                            <i class="fas fa-power-off"></i> Stop Gai
                        </button>
                    </div>
                    <div class="mt-3">
                        <span id="manual-activate-status" class="badge bg-light text-dark"></span>
                        <span id="restart-status" class="badge bg-light text-dark"></span>
                        <span id="stop-status" class="badge bg-light text-dark"></span>
                    </div>
                </div>
            </div>
        </div>
          <!-- Right Column: Stats & Usage -->
        <div>
            <!-- Usage Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-2"></i>Statystyki u≈ºycia
                </div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Wiadomo≈õci</div>
                            <div class="stat-value">{{ stats.get('message_count', 0) }}</div>
                            <div class="stat-label">og√≥≈Çem</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">≈öredni czas odpowiedzi</div>
                            <div class="stat-value">{{ stats.get('avg_response_time', '0.0') }}s</div>
                        </div>
                        <div class="stat-card highlighted">
                            <div class="stat-label">Dzisiejsze zapytania</div>
                            <div class="stat-value">{{ stats.get('today_queries', 0) }}</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Ostatnie zapytanie:</h5>
                        <div class="last-query">
                            "{{ stats.get('last_query', 'Brak ostatnich zapyta≈Ñ') }}"
                        </div>
                    </div>
                </div>            </div>
            
            <!-- Recent Messages -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comments me-2"></i>Ostatnie wiadomo≈õci
                </div>
                <div class="card-body">
                    <div class="message-list">
                        <div id="recent-activity-list">
                            <!-- Recent messages will be inserted here -->
                            <!-- Placeholder messages -->
                            <div class="message-item">
                                <div class="message-avatar user">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="message-content message-bubble">
                                    Dzie≈Ñ dobry Gaja, jaka jest pogoda na dzi≈õ?
                                    <div class="message-time">10:23</div>
                                </div>
                            </div>
                            <div class="message-item">
                                <div class="message-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content message-bubble">
                                    Dzie≈Ñ dobry! Dzi≈õ w Twojej lokalizacji bƒôdzie s≈Çonecznie, temperatura 22¬∞C. Idealna pogoda na spacer!
                                    <div class="message-time">10:24</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Statystyki U≈ºytkowania</div>
                <div class="card-body" id="analytics-section">
                    <div class="alert alert-info">≈Åadowanie statystyk...</div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Manual Activation Button
    const activateBtn = document.getElementById('manual-activate-btn');
    const activateStatus = document.getElementById('manual-activate-status');

    if (activateBtn) {
        activateBtn.addEventListener('click', () => {
            activateStatus.textContent = 'Wysy≈Çanie ≈ºƒÖdania aktywacji...';
            activateStatus.className = 'ms-2 text-info';
            activateBtn.disabled = true;
            fetch('/api/activate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) { // 202 Accepted or 200 OK
                    activateStatus.textContent = body.message || 'Aktywacja wys≈Çana!';
                    activateStatus.className = 'ms-2 text-success';
                } else {
                    activateStatus.textContent = `B≈ÇƒÖd: ${body.error || 'Nie uda≈Ço siƒô wys≈Çaƒá ≈ºƒÖdania.'}`;
                    activateStatus.className = 'ms-2 text-danger';
                }
                setTimeout(() => {
                    activateBtn.disabled = false;
                    activateStatus.textContent = '';
                }, 3000);
            })
            .catch(error => {
                activateStatus.textContent = 'B≈ÇƒÖd wysy≈Çania ≈ºƒÖdania.';
                activateStatus.className = 'ms-2 text-danger';
                activateBtn.disabled = false;
                setTimeout(() => {
                    activateStatus.textContent = '';
                }, 3000);
            });
        });
    }

    // Restart buttons logic
    const restartAssistantBtn = document.getElementById('restart-assistant-btn');
    const restartWebBtn = document.getElementById('restart-web-btn');
    const restartAllBtn = document.getElementById('restart-all-btn');
    const restartStatus = document.getElementById('restart-status');

    function handleRestart(url, label) {
        if (restartStatus) {
            restartStatus.textContent = `Wysy≈Çanie ≈ºƒÖdania: ${label}...`;
            restartStatus.className = 'ms-2 text-info';
        }
        fetch(url, { method: 'POST' })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) {
                    restartStatus.textContent = body.message || `${label} wys≈Çane!`;
                    restartStatus.className = 'ms-2 text-success';
                } else {
                    restartStatus.textContent = `B≈ÇƒÖd: ${body.error || 'Nie uda≈Ço siƒô zrestartowaƒá.'}`;
                    restartStatus.className = 'ms-2 text-danger';
                }
            })
            .catch(() => {
                restartStatus.textContent = 'B≈ÇƒÖd wysy≈Çania ≈ºƒÖdania restartu.';
                restartStatus.className = 'ms-2 text-danger';
            });
    }
    if (restartAssistantBtn) restartAssistantBtn.onclick = () => handleRestart('/api/restart/assistant', 'Restart Assistant');
    if (restartWebBtn) restartWebBtn.onclick = () => handleRestart('/api/restart/web', 'Restart Web Panel');
    if (restartAllBtn) restartAllBtn.onclick = () => handleRestart('/api/restart/all', 'Restart All');

    // Update status badge for Restarting
    function fetchAssistantStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    if (data.status === 'Online') {
                        badge.textContent = 'Online';
                        badge.className = 'badge bg-success';
                    } else if (data.status === 'Restarting') {
                        badge.textContent = 'Restarting';
                        badge.className = 'badge bg-warning text-dark';
                    } else if (data.status === 'Offline') {
                        badge.textContent = 'Offline';
                        badge.className = 'badge bg-danger';
                    } else {
                        badge.textContent = data.status || 'Unknown';
                        badge.className = 'badge bg-secondary';
                    }
                }
            })
            .catch(() => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    badge.textContent = 'Offline';
                    badge.className = 'badge bg-danger';
                }
            });
    }
    setInterval(fetchAssistantStatus, 5000);
    fetchAssistantStatus();

    // DASHBOARD: Polling for assistant status
    function fetchAssistantStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    badge.textContent = data.status || 'Unknown';
                    badge.className = 'badge ' + (data.status === 'Online' ? 'bg-success' : 'bg-secondary');
                }
                // Optionally update other status fields
            })
            .catch(err => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    badge.textContent = 'Offline';
                    badge.className = 'badge bg-danger';
                }
            });
    }
    setInterval(fetchAssistantStatus, 5000); // Poll every 5 seconds
    fetchAssistantStatus(); // Initial fetch

    // DASHBOARD: Fetch and display recent activity
    function fetchRecentActivity() {
        fetch('/api/history?limit=5')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('recent-activity-list');
                if (list) {
                    list.innerHTML = '';
                    (data || []).slice(-5).forEach(entry => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = `[${entry.role}] ${entry.content}`;
                        list.appendChild(li);
                    });
                }
            });
    }
    setInterval(fetchRecentActivity, 5000);
    fetchRecentActivity();

    // DASHBOARD: Fetch and display analytics
    function fetchAnalytics() {
        fetch('/api/analytics')
            .then(response => {
                if (!response.ok) throw new Error('B≈ÇƒÖd API: ' + response.status);
                return response.json();
            })
            .then(data => {
                const section = document.getElementById('analytics-section');
                if (!section) return;
                let html = '<ul class="list-group">';
                html += `<li class="list-group-item">Liczba wiadomo≈õci: <b>${data.msg_count ?? '-'}</b></li>`;
                html += `<li class="list-group-item">Unikalni u≈ºytkownicy: <b>${data.unique_users ? data.unique_users.length : 0}</b> (${data.unique_users ? data.unique_users.join(', ') : ''})</li>`;
                html += `<li class="list-group-item">≈öredni czas odpowiedzi: <b>${(data.avg_response_time || 0).toFixed(2)}s</b></li>`;
                html += `<li class="list-group-item">Ostatnie zapytanie: <b>${data.last_query_time ? new Date(data.last_query_time * 1000).toLocaleString() : '-'}</b></li>`;
                html += '</ul>';
                section.innerHTML = html;
            })
            .catch(err => {
                const section = document.getElementById('analytics-section');
                if (section) section.innerHTML = `<div class='alert alert-danger'>B≈ÇƒÖd ≈Çadowania statystyk: ${err.message}</div>`;
            });
    }
    setInterval(fetchAnalytics, 5000);
    fetchAnalytics();

    // Stop Assistant logic
    const stopAssistantBtn = document.getElementById('stop-assistant-btn');
    const stopStatus = document.getElementById('stop-status');
    if (stopAssistantBtn) stopAssistantBtn.onclick = () => {
        if (stopStatus) {
            stopStatus.textContent = 'Wysy≈Çanie ≈ºƒÖdania zatrzymania...';
            stopStatus.className = 'ms-2 text-info';
        }
        fetch('/api/stop/assistant', { method: 'POST' })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) {
                    stopStatus.textContent = body.message || 'Asystent zatrzymany!';
                    stopStatus.className = 'ms-2 text-success';
                } else {
                    stopStatus.textContent = `B≈ÇƒÖd: ${body.error || 'Nie uda≈Ço siƒô zatrzymaƒá asystenta.'}`;
                    stopStatus.className = 'ms-2 text-danger';
                }
            })
            .catch(() => {
                stopStatus.textContent = 'B≈ÇƒÖd wysy≈Çania ≈ºƒÖdania zatrzymania.';
                stopStatus.className = 'ms-2 text-danger';
            });
    };

    // e.g., connect to a WebSocket endpoint provided by the Flask app
    // and update #assistant-status-badge and other elements based on received messages.
</script>
{% endblock %}
