{% extends "base.html" %}

{# Define default values for stats if not provided #}
{% set stats = stats or {
    "message_count": 0,  
    "avg_response_time": "0.0",
    "today_queries": 0,
    "last_query": "Brak"
} %}

{% set recent_messages = recent_messages or [] %}

{% block content %}
<div class="container mt-4">
    <!-- Dashboard Header with Welcome Message -->
    <div class="gaja-welcome">
        <h1>Good morning, {{ session.username }} üåû</h1>
        <p>I am Gaja. What shall we do today?</p>
    </div>

    <!-- Dashboard Grid Layout -->
    <div class="dashboard-grid">
        <!-- Left Column: Status & Actions -->
        <div>
            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Gaja Status
                </div>
                <div class="card-body">
                    <div class="status-item">
                        <span class="status-indicator {% if status.get('status') == 'Online' %}online{% else %}offline{% endif %}"></span>
                        <span class="status-label">Status:</span>
                        <span id="assistant-status-badge" class="badge {% if status.get('status') == 'Online' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ status.get('status', 'Unknown') }}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Wake Word:</span>
                        <span class="badge" style="background-color: var(--gaja-blue)">{{ config.get('WAKE_WORD', 'N/A') }}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator {% if status.get('microphone') %}online{% else %}offline{% endif %}"></span>
                        <span class="status-label">Mikrofon:</span>
                        <span class="badge {% if status.get('microphone') %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'ON' if status.get('microphone') else 'OFF' }}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator online"></span>
                        <span class="status-label">Internet:</span>
                        <span class="badge bg-success">OK</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>Szybkie akcje
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <button id="manual-activate-btn" class="btn btn-gaja">
                            <i class="fas fa-microphone"></i> Aktywuj mikrofon
                        </button>
                        <button id="restart-assistant-btn" class="btn btn-gaja btn-gaja-primary">
                            <i class="fas fa-sync-alt"></i> Restart Gai
                        </button>
                        <button id="stop-assistant-btn" class="btn btn-gaja btn-gaja-danger">
                            <i class="fas fa-power-off"></i> Stop Gai
                        </button>
                    </div>
                    <div class="mt-3">
                        <span id="manual-activate-status" class="badge bg-light text-dark"></span>
                        <span id="restart-status" class="badge bg-light text-dark"></span>
                        <span id="stop-status" class="badge bg-light text-dark"></span>
                    </div>
                </div>
            </div>
        </div>
          <!-- Right Column: Stats & Usage -->
        <div>
            <!-- Usage Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-2"></i>Usage Statistics
                </div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Messages</div>
                            <div class="stat-value" id="stat-message-count">{{ stats.get('message_count', 0) }}</div>
                            <div class="stat-label">total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average response time</div>
                            <div class="stat-value" id="stat-avg-response-time">{{ stats.get('avg_response_time', '0.0') }}s</div>
                        </div>
                        <div class="stat-card highlighted">
                            <div class="stat-label">Queries today</div>
                            <div class="stat-value" id="stat-today-queries">{{ stats.get('today_queries', 0) }}</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Last query:</h5>
                        <div class="last-query" id="stat-last-query">
                            "{{ stats.get('last_query', 'No recent queries') }}"
                        </div>
                    </div>
                </div>            </div>
            
            <!-- Recent Messages -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comments me-2"></i>Recent messages
                </div>
                <div class="card-body">
                    <div class="message-list" id="recent-activity-list">
                        <!-- Messages will be dynamically inserted here by JavaScript -->
                        {% if not recent_messages %}
                            <p class="text-muted">No recent messages.</p>
                        {% endif %}
                        {# {% for message in recent_messages %}
                        <div class="message-item">
                            <div class="message-avatar {{ message.role }}">
                                <i class="fas fa-{{ 'user' if message.role == 'user' else 'robot' }}"></i>
                            </div>
                            <div class="message-content message-bubble">
                                {{ message.content }}
                                <div class="message-time">{{ message.timestamp.strftime('%H:%M') if message.timestamp else '' }}</div>
                            </div>
                        </div>
                        {% endfor %} #}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Usage Statistics (API)</div>
                <div class="card-body" id="analytics-section">
                    <div class="alert alert-info">≈Åadowanie statystyk...</div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Manual Activation Button
    const activateBtn = document.getElementById('manual-activate-btn');
    const activateStatus = document.getElementById('manual-activate-status');

    if (activateBtn) {
        activateBtn.addEventListener('click', () => {
            activateStatus.textContent = 'Sending activation request...';
            activateStatus.className = 'ms-2 text-info';
            activateBtn.disabled = true;
            fetch('/api/activate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) { // 202 Accepted or 200 OK
                    activateStatus.textContent = body.message || 'Activation sent!';
                    activateStatus.className = 'ms-2 text-success';
                } else {
                    activateStatus.textContent = `Error: ${body.error || 'Failed to send request.'}`;
                    activateStatus.className = 'ms-2 text-danger';
                }
                setTimeout(() => {
                    activateBtn.disabled = false;
                    activateStatus.textContent = '';
                }, 3000);
            })
            .catch(error => {
                activateStatus.textContent = 'Error sending request.';
                activateStatus.className = 'ms-2 text-danger';
                activateBtn.disabled = false;
                setTimeout(() => {
                    activateStatus.textContent = '';
                }, 3000);
            });
        });
    }

    // Restart buttons logic
    const restartAssistantBtn = document.getElementById('restart-assistant-btn');
    const restartWebBtn = document.getElementById('restart-web-btn'); // Assuming you might add this
    const restartAllBtn = document.getElementById('restart-all-btn'); // Assuming you might add this
    const restartStatus = document.getElementById('restart-status');

    function handleRestart(url, label) {
        if (restartStatus) {
            restartStatus.textContent = `Sending request: ${label}...`;
            restartStatus.className = 'ms-2 text-info';
        }
        fetch(url, { method: 'POST' })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) {
                    restartStatus.textContent = body.message || `${label} sent!`;
                    restartStatus.className = 'ms-2 text-success';
                } else {
                    restartStatus.textContent = `Error: ${body.error || 'Failed to restart.'}`;
                    restartStatus.className = 'ms-2 text-danger';
                }
            })
            .catch(() => {
                restartStatus.textContent = 'Error sending restart request.';
                restartStatus.className = 'ms-2 text-danger';
            });
    }
    if (restartAssistantBtn) restartAssistantBtn.onclick = () => handleRestart('/api/restart/assistant', 'Restart Assistant');
    // if (restartWebBtn) restartWebBtn.onclick = () => handleRestart('/api/restart/web', 'Restart Web Panel');
    // if (restartAllBtn) restartAllBtn.onclick = () => handleRestart('/api/restart/all', 'Restart All');

    // Stop Assistant logic
    const stopAssistantBtn = document.getElementById('stop-assistant-btn');
    const stopStatus = document.getElementById('stop-status');
    if (stopAssistantBtn) stopAssistantBtn.onclick = () => {
        if (stopStatus) {
            stopStatus.textContent = 'Sending stop request...';
            stopStatus.className = 'ms-2 text-info';
        }
        fetch('/api/stop/assistant', { method: 'POST' })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 202 || status === 200) {
                    stopStatus.textContent = body.message || 'Asystent zatrzymany!';
                    stopStatus.className = 'ms-2 text-success';
                } else {
                    stopStatus.textContent = `Error: ${body.error || 'Failed to stop assistant.'}`;
                    stopStatus.className = 'ms-2 text-danger';
                }
            })
            .catch(() => {
                stopStatus.textContent = 'Error sending stop request.';
                stopStatus.className = 'ms-2 text-danger';
            });
    };


    // DASHBOARD: Polling for assistant status
    function fetchAssistantStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    if (data.status === 'Online') {
                        badge.textContent = 'Online';
                        badge.className = 'badge bg-success';
                    } else if (data.status === 'Restarting') {
                        badge.textContent = 'Restarting';
                        badge.className = 'badge bg-warning text-dark';
                    } else if (data.status === 'Offline') {
                        badge.textContent = 'Offline';
                        badge.className = 'badge bg-danger';
                    } else {
                        badge.textContent = data.status || 'Unknown';
                        badge.className = 'badge bg-secondary';
                    }
                }
            })
            .catch(() => {
                const badge = document.getElementById('assistant-status-badge');
                if (badge) {
                    badge.textContent = 'Offline';
                    badge.className = 'badge bg-danger';
                }
            });
    }
    setInterval(fetchAssistantStatus, 5000); // Poll every 5 seconds
    fetchAssistantStatus(); // Initial fetch

    // DASHBOARD: Fetch and display recent activity (max 3 messages)
    function fetchRecentActivity() {
        fetch('/api/history?limit=3') // Fetch only 3 messages
            .then(response => response.json())
            .then(data => {
                const listElement = document.getElementById('recent-activity-list');
                if (listElement) {
                    listElement.innerHTML = ''; // Clear existing messages
                    if (data && data.length > 0) {
                        // Take the last 3 messages from the fetched data (which should be already limited by API)
                        const messagesToDisplay = data.slice(-3);
                        messagesToDisplay.forEach(entry => {
                            const messageItem = document.createElement('div');
                            messageItem.className = 'message-item';

                            const avatarDiv = document.createElement('div');
                            avatarDiv.className = `message-avatar ${entry.role}`;
                            if (entry.role === 'user') {
                                const icon = document.createElement('i');
                                icon.className = `fas fa-user`;
                                avatarDiv.appendChild(icon);
                            } else {
                                const img = document.createElement('img');
                                img.src = '/static/img/gaja.svg';
                                img.alt = 'Gaja';
                                img.style.width = '24px'; // Adjust size as needed
                                img.style.height = '24px'; // Adjust size as needed
                                avatarDiv.appendChild(img);
                            }

                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'message-content message-bubble';
                            contentDiv.textContent = entry.content;
                            
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'message-time';
                            // Format timestamp if available
                            if (entry.timestamp) {
                                try {
                                    timeDiv.textContent = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                } catch (e) {
                                    timeDiv.textContent = entry.timestamp.split(' ')[1].substring(0,5); // Fallback for simple time string
                                }
                            } else {
                                timeDiv.textContent = "--:--";
                            }
                            contentDiv.appendChild(timeDiv);

                            messageItem.appendChild(avatarDiv);
                            messageItem.appendChild(contentDiv);
                            listElement.appendChild(messageItem);
                        });
                    } else {
                        listElement.innerHTML = '<p class="text-muted">No recent messages.</p>';
                    }
                }
            })
            .catch(error => {
                const listElement = document.getElementById('recent-activity-list');
                if (listElement) {
                    listElement.innerHTML = '<p class="text-danger">Error loading messages.</p>';
                }
                console.error('Error fetching recent activity:', error);
            });
    }
    // Initial recent activity and periodic refresh
    fetchRecentActivity();
    setInterval(fetchRecentActivity, 5000);

    // DASHBOARD: Fetch and display analytics for summary cards
    function fetchAnalytics() {
        fetch('/api/analytics')
            .then(response => response.json())
            .then(data => {
                const msgCountEl = document.getElementById('stat-message-count');
                const avgTimeEl = document.getElementById('stat-avg-response-time');
                const todayEl = document.getElementById('stat-today-queries');
                const lastQueryEl = document.getElementById('stat-last-query');
                if (msgCountEl) msgCountEl.textContent = data.msg_count;
                if (avgTimeEl) avgTimeEl.textContent = (data.avg_response_time || 0).toFixed(2) + 's';
                if (todayEl) todayEl.textContent = data.today_queries;
                if (lastQueryEl) lastQueryEl.textContent = '"' + (data.last_query || 'None') + '"';
                // Also render details in analytics section
                const section = document.getElementById('analytics-section');
                if (section) {
                    section.innerHTML = `
                        <div class="row">
                            <div class="col-sm-4"><strong>Unique users:</strong> ${data.unique_users.length}</div>
                            <div class="col-sm-4"><strong>Last query:</strong> ${data.last_query || 'None'}</div>
                            <div class="col-sm-4"><strong>Log count:</strong> ${data.msg_count}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching analytics:', error);
            });
    }
    // Initial analytics and periodic refresh
    fetchAnalytics();
    setInterval(fetchAnalytics, 10000);
    setInterval(fetchRecentActivity, 5000); // Poll every 5 seconds
    fetchRecentActivity(); // Initial fetch

    // DASHBOARD: Fetch and display analytics from API
    function fetchAnalytics() {
        fetch('/api/analytics')
            .then(response => {
                if (!response.ok) throw new Error('API error: ' + response.status);
                return response.json();
            })
            .then(data => {
                const section = document.getElementById('analytics-section');
                if (!section) return;
                // Update main dashboard stats too
                document.getElementById('stat-message-count').textContent = data.msg_count ?? '0';
                document.getElementById('stat-avg-response-time').textContent = (data.avg_response_time || 0).toFixed(1) + 's';
                document.getElementById('stat-today-queries').textContent = data.today_queries ?? '0'; // Assuming API provides this
                document.getElementById('stat-last-query').textContent = `"${data.last_query || 'None'}"`; // Assuming API provides this

                // Update detailed analytics section
                let html = '<ul class="list-group">';
                html += `<li class="list-group-item">Messages (from DB): <b>${data.msg_count ?? '-'}</b></li>`;
                html += `<li class="list-group-item">Unique users (from DB): <b>${data.unique_users ? data.unique_users.length : 0}</b> (${data.unique_users ? data.unique_users.join(', ') : ''})</li>`;
                html += `<li class="list-group-item">Average response time (from DB): <b>${(data.avg_response_time || 0).toFixed(2)}s</b></li>`;
                html += `<li class="list-group-item">Last query (from DB): <b>${data.last_query_time ? new Date(data.last_query_time).toLocaleString() : '-'}</b></li>`;
                html += '</ul>';
                section.innerHTML = html;
            })
            .catch(err => {
                const section = document.getElementById('analytics-section');
                if (section) section.innerHTML = `<div class='alert alert-danger'>Error loading stats: ${err.message}</div>`;
                 // Clear main dashboard stats on error
                document.getElementById('stat-message-count').textContent = '0';
                document.getElementById('stat-avg-response-time').textContent = '0.0s';
                document.getElementById('stat-today-queries').textContent = '0';
                document.getElementById('stat-last-query').textContent = `"Brak"`;
            });
    }
    setInterval(fetchAnalytics, 5000); // Poll every 5 seconds
    fetchAnalytics(); // Initial fetch

</script>
{% endblock %}
