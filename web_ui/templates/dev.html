<!-- filepath: f:\Asystent\web_ui\templates\dev.html.new -->
{% extends "base.html" %}

{% block head_extra %}
<style>
/* Chip buttons */
.chip-button {
  border-radius: 50px;
  padding: 0.5rem 1.25rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
  background-color: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.chip-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.chip-button i {
  font-size: 0.9rem;
}

/* Section styling */
.dev-section {
  background-color: rgba(255, 255, 255, 0.05);
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.dev-section h2 {
  font-size: 1.5rem;
  margin-bottom: 1.25rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.dev-section h2 i {
  color: var(--gaja-primary);
}

/* Test status indicators */
.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}

.status-indicator.passed { background: #4caf50; }
.status-indicator.failed { background: #f44336; }
.status-indicator.running { background: #ffc107; }
.status-indicator.idle { background: #888; }
.status-indicator.success { background: #4caf50; }

/* Test list */
.test-item {
  border-left: 6px solid #e9ecef;
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  background-color: rgba(255, 255, 255, 0.05);
  border-radius: 0.25rem;
}

.test-item.test-ok { border-left-color: #4caf50; }
.test-item.test-fail { border-left-color: #f44336; }
.test-item.test-error { border-left-color: #ffc107; }

/* Test and bench log styling */
.log-container {
  white-space: pre-wrap;
  background: #222;
  color: #eee;
  padding: 1em;
  border-radius: 0.5rem;
  max-height: 300px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 0.85rem;
}

/* Responsive tables */
@media (max-width: 768px) {
  .table-responsive-custom {
    display: block;
    width: 100%;
    overflow-x: auto;
  }
  
  .table-responsive-custom td, 
  .table-responsive-custom th {
    white-space: nowrap;
  }
}

/* User management form */
.user-form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.5rem;
  align-items: start;
}

.user-form-grid .btn {
  align-self: end;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üë®‚Äçüî¨ Zak≈Çadka Dev</h1>

    <!-- Unit Tests Section -->
    <div class="dev-section">
        <h2><i class="fas fa-vial"></i> ‚úÖ Testy jednostkowe</h2>
        <div class="d-flex align-items-center mb-3">
            <button id="run-tests-btn" class="chip-button me-3">
                <i class="fas fa-play"></i> Uruchom testy
            </button>
            <div class="status-display">
                <span id="test-status-dot" class="status-indicator idle"></span>
                <span id="test-status-label">Status: Idle</span>
            </div>
        </div>
        
        <div id="test-summary" class="alert alert-light"></div>
        <div id="ai-summary" class="alert alert-info" style="display: none;"></div>
        
        <div id="test-list" class="mb-3"></div>
        
        <details>
            <summary class="mb-2">Poka≈º pe≈Çny log test√≥w</summary>
            <div id="test-log" class="log-container"></div>
        </details>
    </div>

    <!-- Benchmark Section -->
    <div class="dev-section">
        <h2><i class="fas fa-tachometer-alt"></i> üìä Benchmark systemu</h2>
        <div class="d-flex align-items-center mb-3">
            <button id="run-bench-btn" class="chip-button me-3">
                <i class="fas fa-play"></i> Uruchom benchmark
            </button>
            <div class="status-display">
                <span id="bench-status-dot" class="status-indicator idle"></span>
                <span id="bench-status-label">Status: Idle</span>
            </div>
        </div>
        
        <div id="bench-summary" class="alert alert-light"></div>
        
        <details>
            <summary class="mb-2">Poka≈º pe≈Çny log benchmarku</summary>
            <div id="bench-log" class="log-container"></div>
        </details>
    </div>

    <!-- Performance Stats Section -->
    <div class="dev-section">
        <h2><i class="fas fa-chart-line"></i> üìà Statystyki AI</h2>
        <button id="clear-perf-stats-btn" class="chip-button mb-3">
            <i class="fas fa-eraser"></i> Wyczy≈õƒá statystyki
        </button>
          <div id="perf-stats-table-container" class="table-responsive-custom">
            <table class="table table-striped table-sm" id="perf-stats-table">
                <thead>
                    <tr>
                        <th>Funkcja</th>
                        <th>≈öredni czas (ms)</th>
                        <th>Liczba wywo≈Ça≈Ñ</th>
                        <th>Ca≈Çkowity czas (s)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- User Management Section -->
    <div class="dev-section">
        <h2><i class="fas fa-users-cog"></i> üë§ ZarzƒÖdzanie u≈ºytkownikami</h2>
        <div class="mb-3">
            <form id="add-user-form">
                <div class="user-form-grid">
                    <input type="text" class="form-control" name="username" placeholder="Nazwa u≈ºytkownika" required>
                    <input type="password" class="form-control" name="password" placeholder="Has≈Ço" required>
                    <input type="text" class="form-control" name="display_name" placeholder="Wy≈õwietlana nazwa">
                    <input type="text" class="form-control" name="ai_persona" placeholder="Persona AI">
                    <input type="text" class="form-control" name="personalization" placeholder="Personalizacja">
                    <select class="form-select" name="role">
                        <option value="user">user</option>
                        <option value="dev">dev</option>
                    </select>
                    <button type="submit" class="btn btn-gaja">Dodaj</button>
                </div>
            </form>
            <div id="add-user-status" class="mt-2"></div>
        </div>
        
        <div class="table-responsive-custom">
            <table class="table table-sm" id="users-table">
                <thead>
                    <tr>
                        <th>Nazwa u≈ºytkownika</th>
                        <th>Rola</th>
                        <th>Wy≈õwietlana nazwa</th>
                        <th>Persona AI</th>
                        <th>Personalizacja</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                {% for user in users %}
                    <tr>
                        <td>{{ user['username'] }}</td>
                        <td>{{ user['role'] }}</td>
                        <td>{{ user['display_name'] or '' }}</td>
                        <td>{{ user['ai_persona'] or '' }}</td>
                        <td>{{ user['personalization'] or '' }}</td>
                        <td>
                            {% if user['username'] != 'dev' %}
                            <button class="btn btn-sm btn-outline-danger delete-user-btn" data-username="{{ user['username'] }}">Usu≈Ñ</button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Testing History Section -->
    <div class="dev-section">
        <h2><i class="fas fa-history"></i> üìÖ Historia i planowanie test√≥w</h2>
        <form id="schedule-tests-form" class="d-flex gap-2 mb-4 align-items-center">
            <input type="number" id="schedule-interval" class="form-control" placeholder="Interwa≈Ç (minuty)" min="1" required style="max-width: 200px;">
            <button type="submit" class="chip-button">
                <i class="fas fa-calendar"></i> Zaplanuj
            </button>
            <span id="schedule-status-label" class="ms-2">Brak harmonogramu</span>
        </form>
        
        <div class="table-responsive-custom">
            <table class="table table-sm" id="test-history-table">
                <thead>
                    <tr>
                        <th>Czas</th>
                        <th>Wynik</th>
                        <th>Podsumowanie</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data loaded dynamically -->
                </tbody>
            </table>
        </div>    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Test execution and monitoring
document.getElementById('run-tests-btn').addEventListener('click', function() {
    this.disabled = true;
    const statusDot = document.getElementById('test-status-dot');
    const statusLabel = document.getElementById('test-status-label');
    const testList = document.getElementById('test-list');
    const testLog = document.getElementById('test-log');
    const testSummary = document.getElementById('test-summary');
    const aiSummary = document.getElementById('ai-summary');
    
    // Reset UI
    statusDot.className = 'status-indicator running';
    statusLabel.textContent = 'Status: Uruchomiono...';
    testList.innerHTML = '';
    testLog.textContent = 'Uruchamianie test√≥w...';
    testSummary.textContent = '';
    testSummary.className = 'alert alert-light';
    aiSummary.style.display = 'none';
    
    // Start tests
    fetch('/api/run_tests', { method: 'POST' })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.status === 'started') {
                // Start polling for status
                pollTestStatus();
            } else {
                throw new Error('Nie uda≈Ço siƒô rozpoczƒÖƒá test√≥w');
            }
        })
        .catch(error => {
            statusDot.className = 'status-indicator failed';
            statusLabel.textContent = 'Status: B≈ÇƒÖd';
            testSummary.textContent = `B≈ÇƒÖd: ${error.message}`;
            testSummary.className = 'alert alert-danger';
            this.disabled = false;
        });
});

function pollTestStatus() {
    const statusDot = document.getElementById('test-status-dot');
    const statusLabel = document.getElementById('test-status-label');
    const testList = document.getElementById('test-list');
    const testLog = document.getElementById('test-log');
    const testSummary = document.getElementById('test-summary');
    const aiSummary = document.getElementById('ai-summary');
    const runButton = document.getElementById('run-tests-btn');
    
    fetch('/api/test_status')
        .then(response => response.json())
        .then(data => {
            // Update log
            testLog.textContent = data.log || 'Brak log√≥w';
            
            // Update test list
            updateTestList(testList, data.tests || []);
            
            // Update status
            if (data.running) {
                statusDot.className = 'status-indicator running';
                statusLabel.textContent = 'Status: Uruchomiono...';
                setTimeout(pollTestStatus, 1000); // Continue polling
            } else {
                // Tests completed
                if (data.result === 'passed') {
                    statusDot.className = 'status-indicator passed';
                    statusLabel.textContent = 'Status: Sukces';
                    testSummary.textContent = data.summary || 'Wszystkie testy przesz≈Çy pomy≈õlnie';
                    testSummary.className = 'alert alert-success';
                } else {
                    statusDot.className = 'status-indicator failed';
                    statusLabel.textContent = 'Status: B≈ÇƒÖd';
                    testSummary.textContent = data.summary || 'Niekt√≥re testy nie przesz≈Çy';
                    testSummary.className = 'alert alert-danger';
                }
                
                // Show AI summary if available
                if (data.ai_summary) {
                    aiSummary.textContent = data.ai_summary;
                    aiSummary.style.display = 'block';
                }
                
                runButton.disabled = false;
                fetchTestHistory(); // Update history
            }
        })
        .catch(error => {
            console.error('Error polling test status:', error);
            setTimeout(pollTestStatus, 2000); // Retry after a delay
        });
}

function updateTestList(container, tests) {
    if (!tests.length) return;
    
    let html = '';
    tests.forEach(test => {
        const statusClass = test.status === 'ok' ? 'test-ok' : 
                           (test.status === 'FAIL' ? 'test-fail' : 'test-error');
        
        html += `<div class="test-item ${statusClass}">
                    <div><b>${test.name}</b> ${test.class ? `(${test.class})` : ''}</div>
                    ${test.details ? `<div class="test-details mt-2">${test.details}</div>` : ''}
                </div>`;
    });
    
    container.innerHTML = html;
}

// Benchmark functions
document.getElementById('run-bench-btn').addEventListener('click', function() {
    this.disabled = true;
    const statusDot = document.getElementById('bench-status-dot');
    const statusLabel = document.getElementById('bench-status-label');
    const benchLog = document.getElementById('bench-log');
    const benchSummary = document.getElementById('bench-summary');
    
    // Reset UI
    statusDot.className = 'status-indicator running';
    statusLabel.textContent = 'Status: Uruchomiono...';
    benchLog.textContent = 'Uruchamianie benchmarku...';
    benchSummary.textContent = '';
    benchSummary.className = 'alert alert-light';
    
    // Start benchmark
    fetch('/api/run_benchmarks', { method: 'POST' })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.status === 'started') {
                // Start polling for status
                pollBenchStatus();
            } else {
                throw new Error('Nie uda≈Ço siƒô rozpoczƒÖƒá benchmarku');
            }
        })
        .catch(error => {
            statusDot.className = 'status-indicator failed';
            statusLabel.textContent = 'Status: B≈ÇƒÖd';
            benchSummary.textContent = `B≈ÇƒÖd: ${error.message}`;
            benchSummary.className = 'alert alert-danger';
            this.disabled = false;
        });
});

function pollBenchStatus() {
    const statusDot = document.getElementById('bench-status-dot');
    const statusLabel = document.getElementById('bench-status-label');
    const benchLog = document.getElementById('bench-log');
    const benchSummary = document.getElementById('bench-summary');
    const runButton = document.getElementById('run-bench-btn');
    
    fetch('/api/bench_status')
        .then(response => response.json())
        .then(data => {
            // Update log
            benchLog.textContent = data.log || 'Brak log√≥w';
            
            // Update status
            if (data.running) {
                statusDot.className = 'status-indicator running';
                statusLabel.textContent = 'Status: Uruchomiono...';
                setTimeout(pollBenchStatus, 1000); // Continue polling
            } else {
                // Benchmark completed
                statusDot.className = 'status-indicator passed';
                statusLabel.textContent = 'Status: Zako≈Ñczono';
                benchSummary.textContent = data.summary || 'Benchmark zako≈Ñczony';
                benchSummary.className = 'alert alert-info';
                runButton.disabled = false;
                
                updateBenchmarkResults(data.result || {});
            }
        })
        .catch(error => {
            console.error('Error polling benchmark status:', error);
            setTimeout(pollBenchStatus, 2000); // Retry after a delay
        });
}

function updateBenchmarkResults(results) {
    // Additional visualization could be added here in the future
}

// Performance stats
document.getElementById('clear-perf-stats-btn').addEventListener('click', function() {
    if (confirm('Na pewno wyczy≈õciƒá wszystkie statystyki wydajno≈õci?')) {
        fetch('/api/performance_stats', { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    fetchPerfStats(); // Refresh display
                    alert('Statystyki wydajno≈õci zosta≈Çy wyczyszczone');
                }
            })
            .catch(error => console.error('Error clearing perf stats:', error));
        }
});

function fetchPerfStats() {
    fetch('/api/performance_stats')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('#perf-stats-table tbody');
            if (!tableBody) {
                console.error('Performance stats table body not found');
                return;
            }
            tableBody.innerHTML = '';
            
            console.log('Performance stats data:', data);
            
            // Check if we have data
            if (data && Object.keys(data).length > 0) {
                // Convert the object format to an array for display
                Object.entries(data).forEach(([functionName, statInfo]) => {
                    const row = document.createElement('tr');
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = functionName;
                    
                    const avgTimeCell = document.createElement('td');
                    const avgTime = parseFloat(statInfo.average_ms || 0);
                    avgTimeCell.textContent = avgTime.toFixed(2);
                    
                    const countCell = document.createElement('td');
                    countCell.textContent = statInfo.count || 0;
                    
                    const totalTimeCell = document.createElement('td');
                    // Calculate total time in seconds
                    const totalTime = (avgTime * (statInfo.count || 0)) / 1000;
                    totalTimeCell.textContent = totalTime.toFixed(3);
                    
                    row.appendChild(nameCell);
                    row.appendChild(avgTimeCell);
                    row.appendChild(countCell);
                    row.appendChild(totalTimeCell);
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 4;
                cell.textContent = 'Brak danych';
                cell.className = 'text-center';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        })
        .catch(error => {
            console.error('Error fetching performance stats:', error);
            // Add fallback error display in the table
            const tableBody = document.querySelector('#perf-stats-table tbody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            B≈ÇƒÖd podczas ≈Çadowania statystyk: ${error.message || 'Nieznany b≈ÇƒÖd'}
                        </td>
                    </tr>
                `;
            }
        });
}

// User management
document.getElementById('add-user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const statusContainer = document.getElementById('add-user-status');
    statusContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-light me-2" role="status"></div> Dodawanie u≈ºytkownika...';
    
    const formData = new FormData(this);
    const userData = {};
    formData.forEach((value, key) => {
        userData[key] = value;
    });
    
    fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusContainer.innerHTML = '<div class="alert alert-success">U≈ºytkownik zosta≈Ç dodany pomy≈õlnie.</div>';
            this.reset();
            fetchUsers(); // Refresh user list
        } else {
            statusContainer.innerHTML = `<div class="alert alert-danger">B≈ÇƒÖd: ${data.error || 'Nie uda≈Ço siƒô dodaƒá u≈ºytkownika'}</div>`;
        }
    })
    .catch(error => {
        statusContainer.innerHTML = `<div class="alert alert-danger">B≈ÇƒÖd: ${error.message || 'WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd'}</div>`;
    });
});

function setupDeleteUserButtons() {
    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function() {
            const username = this.getAttribute('data-username');
            
            if (confirm(`Czy na pewno chcesz usunƒÖƒá u≈ºytkownika "${username}"?`)) {
                fetch(`/api/users/${username}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fetchUsers(); // Refresh user list
                        document.getElementById('add-user-status').innerHTML = 
                            `<div class="alert alert-success">U≈ºytkownik "${username}" zosta≈Ç usuniƒôty.</div>`;
                    } else {
                        document.getElementById('add-user-status').innerHTML = 
                            `<div class="alert alert-danger">B≈ÇƒÖd: ${data.error || 'Nie uda≈Ço siƒô usunƒÖƒá u≈ºytkownika'}</div>`;
                    }
                })
                .catch(error => {
                    document.getElementById('add-user-status').innerHTML = 
                        `<div class="alert alert-danger">B≈ÇƒÖd: ${error.message || 'WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd'}</div>`;
                });
            }
        });
    });
}

function fetchUsers() {
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('#users-table tbody');
            tableBody.innerHTML = '';
            
            data.forEach(user => {
                const row = document.createElement('tr');
                
                const usernameCell = document.createElement('td');
                usernameCell.textContent = user.username;
                
                const roleCell = document.createElement('td');
                roleCell.textContent = user.role;
                
                const displayNameCell = document.createElement('td');
                displayNameCell.textContent = user.display_name || '';
                
                const aiPersonaCell = document.createElement('td');
                aiPersonaCell.textContent = user.ai_persona || '';
                
                const personalizationCell = document.createElement('td');
                personalizationCell.textContent = user.personalization || '';
                
                const actionsCell = document.createElement('td');
                if (user.username !== 'dev') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger delete-user-btn';
                    deleteBtn.textContent = 'Usu≈Ñ';
                    deleteBtn.setAttribute('data-username', user.username);
                    actionsCell.appendChild(deleteBtn);
                }
                
                row.appendChild(usernameCell);
                row.appendChild(roleCell);
                row.appendChild(displayNameCell);
                row.appendChild(aiPersonaCell);
                row.appendChild(personalizationCell);
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
            
            setupDeleteUserButtons();
        })
        .catch(error => console.error('Error fetching users:', error));
}

// Test history and scheduling
document.getElementById('schedule-tests-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const interval = document.getElementById('schedule-interval').value;
    const statusLabel = document.getElementById('schedule-status-label');
    
    statusLabel.textContent = 'Ustawianie harmonogramu...';
    
    fetch('/api/schedule_tests', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ interval: parseInt(interval) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusLabel.textContent = `Harmonogram: co ${interval} min`;
            this.reset();
        } else {
            statusLabel.textContent = `B≈ÇƒÖd: ${data.error || 'Nie uda≈Ço siƒô ustawiƒá harmonogramu'}`;
        }
    })
    .catch(error => {
        statusLabel.textContent = `B≈ÇƒÖd: ${error.message || 'WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd'}`;
    });
});

function fetchScheduleStatus() {
    fetch('/api/schedule_status')
        .then(response => response.json())
        .then(data => {
            const statusLabel = document.getElementById('schedule-status-label');
            if (data.active && data.interval) {
                statusLabel.textContent = `Harmonogram: co ${data.interval} min`;
            } else {
                statusLabel.textContent = 'Brak harmonogramu';
            }
        })
        .catch(error => console.error('Error fetching schedule status:', error));
}

function fetchTestHistory() {
    fetch('/api/test_history')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('#test-history-table tbody');
            tableBody.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(entry => {
                    const row = document.createElement('tr');
                    
                    const timeCell = document.createElement('td');
                    const date = new Date(entry.timestamp);
                    timeCell.textContent = date.toLocaleString();
                    
                    const resultCell = document.createElement('td');
                    resultCell.textContent = entry.result === 'passed' ? 'Sukces' : 'B≈ÇƒÖd';
                    resultCell.className = entry.result === 'passed' ? 'text-success' : 'text-danger';
                    
                    const summaryCell = document.createElement('td');
                    summaryCell.textContent = entry.summary || '';
                    
                    row.appendChild(timeCell);
                    row.appendChild(resultCell);
                    row.appendChild(summaryCell);
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 3;
                cell.textContent = 'Brak danych historycznych';
                cell.className = 'text-center';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        })
        .catch(error => console.error('Error fetching test history:', error));
}

// Plugin Playground functionality
let currentPlugins = {};

// Load available plugins
function loadPlugins() {    fetch('/api/playground/plugins')
        .then(response => response.json())
        .then(data => {
            console.log('Loaded plugins from playground API:', data);
            currentPlugins = data.plugins || {};
            console.log('Current plugins object:', currentPlugins);
            console.log('Plugin keys:', Object.keys(currentPlugins));
            const pluginSelect = document.getElementById('plugin-select');
            pluginSelect.innerHTML = '<option value="">-- Wybierz plugin --</option>';
            
            Object.keys(currentPlugins).forEach(pluginName => {
                console.log('Processing plugin:', pluginName);
                const option = document.createElement('option');
                option.value = pluginName;
                option.textContent = `${pluginName} (${currentPlugins[pluginName].sub_commands?.length || 0} podkomend)`;
                pluginSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading plugins:', error);
            document.getElementById('plugin-result').textContent = `B≈ÇƒÖd ≈Çadowania plugin√≥w: ${error.message}`;
        });
}

// Handle plugin selection
document.getElementById('plugin-select').addEventListener('change', function() {
    const selectedPlugin = this.value;
    const subcommandSection = document.getElementById('subcommand-section');
    const subcommandSelect = document.getElementById('subcommand-select');
    const paramsSection = document.getElementById('params-section');
    const pluginInfo = document.getElementById('plugin-info');
    const executeBtn = document.getElementById('execute-plugin-btn');
    const viewSourceBtn = document.getElementById('view-source-btn');
    
    if (selectedPlugin && currentPlugins[selectedPlugin]) {
        const plugin = currentPlugins[selectedPlugin];
        
        // Show plugin info
        pluginInfo.style.display = 'block';
        document.getElementById('plugin-info-content').innerHTML = `
            <strong>Opis:</strong> ${plugin.description || 'Brak opisu'}<br>
            <strong>Kategoria:</strong> ${plugin.category || 'Nieznana'}<br>
            <strong>Podkomendy:</strong> ${plugin.sub_commands?.length || 0}
        `;
        
        // Setup subcommands
        subcommandSelect.innerHTML = '<option value="">-- Wybierz podkomendƒô --</option>';
        if (plugin.sub_commands && plugin.sub_commands.length > 0) {
            subcommandSection.style.display = 'block';
            plugin.sub_commands.forEach(subcmd => {
                const option = document.createElement('option');
                option.value = subcmd.name;
                option.textContent = `${subcmd.name} - ${subcmd.description || 'Brak opisu'}`;
                subcommandSelect.appendChild(option);
            });
        } else {
            subcommandSection.style.display = 'none';
            // Enable execute button for plugins without subcommands
            executeBtn.disabled = false;
        }
        
        viewSourceBtn.disabled = false;
    } else {
        subcommandSection.style.display = 'none';
        paramsSection.style.display = 'none';
        pluginInfo.style.display = 'none';
        executeBtn.disabled = true;
        viewSourceBtn.disabled = true;
    }
    
    // Clear params when changing plugin
    document.getElementById('params-container').innerHTML = '';
});

// Handle subcommand selection
document.getElementById('subcommand-select').addEventListener('change', function() {
    const selectedPlugin = document.getElementById('plugin-select').value;
    const selectedSubcommand = this.value;
    const paramsSection = document.getElementById('params-section');
    const paramsContainer = document.getElementById('params-container');
    const executeBtn = document.getElementById('execute-plugin-btn');
    
    paramsContainer.innerHTML = '';
    
    if (selectedPlugin && selectedSubcommand && currentPlugins[selectedPlugin]) {
        const plugin = currentPlugins[selectedPlugin];
        const subcmd = plugin.sub_commands?.find(sc => sc.name === selectedSubcommand);
        
        if (subcmd && subcmd.parameters) {
            paramsSection.style.display = 'block';
            
            subcmd.parameters.forEach(param => {
                const paramDiv = document.createElement('div');
                paramDiv.className = 'mb-2';
                paramDiv.innerHTML = `
                    <label class="form-label">${param.name} ${param.required ? '*' : ''}</label>
                    <input type="text" class="form-control param-input" 
                           data-param="${param.name}" 
                           placeholder="${param.description || ''}"
                           ${param.required ? 'required' : ''}>
                    <small class="form-text text-muted">Typ: ${param.type || 'string'}</small>
                `;
                paramsContainer.appendChild(paramDiv);
            });
        } else {
            paramsSection.style.display = 'none';
        }
        
        executeBtn.disabled = false;
    } else {
        paramsSection.style.display = 'none';
        executeBtn.disabled = selectedPlugin ? false : true;
    }
});

// Execute plugin
document.getElementById('execute-plugin-btn').addEventListener('click', function() {
    const selectedPlugin = document.getElementById('plugin-select').value;
    const selectedSubcommand = document.getElementById('subcommand-select').value;
    const useContext = document.getElementById('use-context').checked;
    const statusDot = document.getElementById('plugin-status-dot');
    const statusLabel = document.getElementById('plugin-status-label');
    const resultDiv = document.getElementById('plugin-result');
    
    if (!selectedPlugin) {
        alert('Wybierz plugin do wykonania');
        return;
    }
    
    // Collect parameters
    const params = {};
    document.querySelectorAll('.param-input').forEach(input => {
        const paramName = input.getAttribute('data-param');
        if (input.value.trim()) {
            // Try to parse as JSON, fallback to string
            try {
                params[paramName] = JSON.parse(input.value);
            } catch {
                params[paramName] = input.value;
            }
        }
    });
    
    // Update status
    statusDot.className = 'status-indicator running';
    statusLabel.textContent = 'Status: Wykonywanie...';
    resultDiv.textContent = 'Wykonywanie pluginu...';
    
    // Prepare request data
    const requestData = {
        plugin_name: selectedPlugin,
        sub_command: selectedSubcommand || null,
        parameters: params,
        use_context: useContext
    };
    
    // Execute plugin
    fetch('/api/playground/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        statusDot.className = data.success ? 'status-indicator success' : 'status-indicator failed';
        statusLabel.textContent = data.success ? 'Status: Sukces' : 'Status: B≈ÇƒÖd';
        
        if (data.success) {
            let resultText = '';
            if (typeof data.result === 'object') {
                resultText = JSON.stringify(data.result, null, 2);
            } else {
                resultText = String(data.result || '');
            }
            
            resultDiv.innerHTML = `
                <div class="alert alert-success mb-2">‚úÖ Plugin wykonany pomy≈õlnie</div>
                <strong>Wynik:</strong><br>
                <pre>${resultText}</pre>
                ${data.execution_time ? `<small class="text-muted">Czas wykonania: ${data.execution_time}ms</small>` : ''}
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger mb-2">‚ùå B≈ÇƒÖd wykonania</div>
                <strong>B≈ÇƒÖd:</strong> ${data.error || 'Nieznany b≈ÇƒÖd'}
                ${data.details ? `<br><strong>Szczeg√≥≈Çy:</strong> ${data.details}` : ''}
            `;
        }
    })
    .catch(error => {
        statusDot.className = 'status-indicator failed';
        statusLabel.textContent = 'Status: B≈ÇƒÖd';
        resultDiv.innerHTML = `
            <div class="alert alert-danger mb-2">‚ùå B≈ÇƒÖd komunikacji</div>
            <strong>B≈ÇƒÖd:</strong> ${error.message}
        `;
    });
});

// View source code
document.getElementById('view-source-btn').addEventListener('click', function() {
    const selectedPlugin = document.getElementById('plugin-select').value;
    
    if (!selectedPlugin) {
        alert('Wybierz plugin aby zobaczyƒá kod ≈∫r√≥d≈Çowy');
        return;
    }
    
    fetch(`/api/playground/plugin/${selectedPlugin}/info`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.source_code) {
                document.getElementById('source-code-content').textContent = data.source_code;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('sourceCodeModal'));
                modal.show();
                
                // Apply syntax highlighting if Prism.js is available
                if (typeof Prism !== 'undefined') {
                    Prism.highlightElement(document.getElementById('source-code-content'));
                }
            } else {
                alert('Nie uda≈Ço siƒô pobraƒá kodu ≈∫r√≥d≈Çowego: ' + (data.error || 'Nieznany b≈ÇƒÖd'));
            }
        })
        .catch(error => {
            alert('B≈ÇƒÖd pobierania kodu ≈∫r√≥d≈Çowego: ' + error.message);
        });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded - initializing components');
    
    // First, ensure all tables have proper structure
    const perfTableBody = document.querySelector('#perf-stats-table tbody');
    if (!perfTableBody) {
        console.error('Performance stats table body not found on page load');
    }
    
    fetchPerfStats();
    fetchUsers();
    fetchTestHistory();
    fetchScheduleStatus();
    
    setupDeleteUserButtons();
      // Set up polling for test stats
    setInterval(fetchPerfStats, 30000);
});
</script>
{% endblock %}
