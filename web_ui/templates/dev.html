{% extends "base.html" %}
{% block content %}
    <h1>Zakładka Dev – Testy jednostkowe</h1>
    <button id="run-tests-btn" class="btn btn-primary mb-3">Uruchom testy</button>
    <span id="test-status-dot" class="idle"></span>
    <span id="test-status-label">Status: Idle</span>
    <div id="test-summary" class="mt-2"></div>
    <div id="ai-summary" class="mb-3"></div>
    <div id="test-list"></div>
    <details class="mt-3">
        <summary>Pokaż pełny log testów</summary>
        <div id="test-log"></div>
    </details>
    <script>
    const runBtn = document.getElementById('run-tests-btn');
    const statusDot = document.getElementById('test-status-dot');
    const statusLabel = document.getElementById('test-status-label');
    const summaryDiv = document.getElementById('test-summary');
    const aiSummaryDiv = document.getElementById('ai-summary');
    const logDiv = document.getElementById('test-log');
    const testListDiv = document.getElementById('test-list');
    let polling = false;

    function setStatus(status) {
        statusDot.className = '';
        if (status === 'passed') {
            statusDot.classList.add('passed');
            statusLabel.textContent = 'Status: Zaliczone';
        } else if (status === 'failed') {
            statusDot.classList.add('failed');
            statusLabel.textContent = 'Status: Błędy';
        } else if (status === 'running') {
            statusDot.classList.add('running');
            statusLabel.textContent = 'Status: W trakcie...';
        } else {
            statusDot.classList.add('idle');
            statusLabel.textContent = 'Status: Idle';
        }
    }

    function renderTestList(tests) {
        if (!tests || !tests.length) {
            testListDiv.innerHTML = '<div class="alert alert-info">Brak wyników testów.</div>';
            return;
        }
        let html = '<div class="list-group">';
        for (const t of tests) {
            let statusIcon = '';
            let itemClass = 'list-group-item d-flex justify-content-between align-items-center';
            if (t.status === 'ok') {
                statusIcon = '<span class="badge bg-success rounded-pill">✔</span>';
                itemClass += ' test-ok';
            } else if (t.status === 'FAIL') {
                statusIcon = '<span class="badge bg-danger rounded-pill">✖</span>';
                itemClass += ' test-fail';
            } else if (t.status === 'ERROR') {
                statusIcon = '<span class="badge bg-warning text-dark rounded-pill">!</span>';
                itemClass += ' test-error';
            } else {
                statusIcon = '<span class="badge bg-secondary rounded-pill">?</span>';
            }
            html += `<div class="${itemClass}">
                <div>
                    <span class="fw-bold">${t.name}</span>
                    ${t.class ? `<span class="text-muted ms-2">(${t.class})</span>` : ''}
                    <span class="ms-2">${statusIcon}</span>
                </div>
                <div>
                    <span class="fw-bold">${t.status}</span>
                    ${t.details ? `<button class="btn btn-link btn-sm ms-2" type="button" onclick="this.nextElementSibling.classList.toggle('d-none')">Szczegóły</button>
                    <div class='alert alert-danger mt-2 mb-0 d-none' style='white-space:pre-wrap;font-size:0.95em;'>${t.details}</div>` : ''}
                </div>
            </div>`;
        }
        html += '</div>';
        testListDiv.innerHTML = html;
    }

    function pollStatus() {
        fetch('/api/test_status').then(r => r.json()).then(data => {
            setStatus(data.running ? 'running' : (data.result || 'idle'));
            summaryDiv.textContent = data.summary || '';
            aiSummaryDiv.textContent = data.ai_summary ? 'AI: ' + data.ai_summary : '';
            logDiv.textContent = data.log || '';
            renderTestList(data.tests);
            if (data.running) {
                setTimeout(pollStatus, 1000);
            } else {
                polling = false;
            }
        });
    }

    runBtn.addEventListener('click', () => {
        fetch('/api/run_tests', {method: 'POST'}).then(r => {
            if (r.ok) {
                polling = true;
                pollStatus();
            } else {
                r.json().then(data => alert('Testy już trwają!'));
            }
        });
        setStatus('running');
        summaryDiv.textContent = '';
        aiSummaryDiv.textContent = '';
        logDiv.textContent = '';
        testListDiv.innerHTML = '';
    });

    pollStatus();
    </script>
    <style>
        #test-log { white-space: pre-wrap; background: #222; color: #eee; padding: 1em; border-radius: 6px; max-height: 300px; overflow-y: auto; }
        #test-summary, #ai-summary { margin-top: 1em; font-weight: bold; }
        #test-status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        #test-status-dot.passed { background: #4caf50; }
        #test-status-dot.failed { background: #f44336; }
        #test-status-dot.running { background: #ffc107; }
        #test-status-dot.idle { background: #888; }
        .list-group-item.test-ok { border-left: 6px solid #4caf50; }
        .list-group-item.test-fail { border-left: 6px solid #f44336; }
        .list-group-item.test-error { border-left: 6px solid #ffc107; }
        .list-group-item { margin-bottom: 0.5em; }
    </style>
{% endblock %}
