{% extends "base.html" %}
{% block content %}
    <h1>Zakładka Dev – Testy jednostkowe</h1>
    <button id="run-tests-btn" class="btn btn-primary mb-3">Uruchom testy</button>
    <span id="test-status-dot" class="idle"></span>
    <span id="test-status-label">Status: Idle</span>
    <div id="test-summary" class="mt-2"></div>
    <div id="ai-summary" class="mb-3"></div>
    <div id="test-list"></div>
    <details class="mt-3">
        <summary>Pokaż pełny log testów</summary>
        <div id="test-log"></div>
    </details>

    <hr>
    <h1>Benchmarki systemu</h1>
    <button id="run-bench-btn" class="btn btn-secondary mb-3">Uruchom benchmarki</button>
    <span id="bench-status-dot" class="idle"></span>
    <span id="bench-status-label">Status: Idle</span>
    <div id="bench-summary" class="mt-2"></div>
    <details class="mt-3">
        <summary>Pokaż pełny log benchmarku</summary>
        <div id="bench-log" style="white-space: pre-wrap; background: #f5f5f5; padding: 1em; border-radius: 6px; max-height: 300px; overflow-y: auto;"></div>
    </details>

    <hr>
    <h2>Zarządzanie użytkownikami</h2>
    <div class="mb-3">
        <form id="add-user-form" class="row g-2">
            <div class="col-md-2"><input type="text" class="form-control" name="username" placeholder="Nazwa użytkownika" required></div>
            <div class="col-md-2"><input type="password" class="form-control" name="password" placeholder="Hasło" required></div>
            <div class="col-md-2"><input type="text" class="form-control" name="display_name" placeholder="Wyświetlana nazwa"></div>
            <div class="col-md-2"><input type="text" class="form-control" name="ai_persona" placeholder="Persona AI"></div>
            <div class="col-md-2"><input type="text" class="form-control" name="personalization" placeholder="Personalizacja"></div>
            <div class="col-md-1">
                <select class="form-select" name="role">
                    <option value="user">user</option>
                    <option value="dev">dev</option>
                </select>
            </div>
            <div class="col-md-1"><button type="submit" class="btn btn-success">Dodaj</button></div>
        </form>
        <div id="add-user-status" class="mt-2"></div>
    </div>
    <table class="table table-bordered" id="users-table">
        <thead><tr><th>Nazwa użytkownika</th><th>Rola</th><th>Wyświetlana nazwa</th><th>Persona AI</th><th>Personalizacja</th><th>Akcje</th></tr></thead>
        <tbody>
        {% for user in users %}
            <tr>
                <td>{{ user['username'] }}</td>
                <td>{{ user['role'] }}</td>
                <td>{{ user['display_name'] or '' }}</td>
                <td>{{ user['ai_persona'] or '' }}</td>
                <td>{{ user['personalization'] or '' }}</td>
                <td>
                    {% if user['username'] != 'dev' %}
                    <button class="btn btn-danger btn-sm delete-user-btn" data-username="{{ user['username'] }}">Usuń</button>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <hr>
    <h2>Historia testów</h2>
    <table class="table table-sm" id="test-history-table">
        <thead><tr><th>Czas</th><th>Wynik</th><th>Podsumowanie</th></tr></thead>
        <tbody></tbody>
    </table>

    <h2>Planowanie testów</h2>
    <form id="schedule-tests-form" class="row g-2 mb-4">
        <div class="col-auto">
            <input type="number" id="schedule-interval" class="form-control" placeholder="Interwał (minuty)" min="1" required>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-warning">Zaplanuj</button>
        </div>
        <div class="col-auto">
            <span id="schedule-status-label">Brak harmonogramu</span>
        </div>
    </form>
    <script>
    const runBtn = document.getElementById('run-tests-btn');
    const statusDot = document.getElementById('test-status-dot');
    const statusLabel = document.getElementById('test-status-label');
    const summaryDiv = document.getElementById('test-summary');
    const aiSummaryDiv = document.getElementById('ai-summary');
    const logDiv = document.getElementById('test-log');
    const testListDiv = document.getElementById('test-list');
    let polling = false;

    function setStatus(status) {
        statusDot.className = '';
        if (status === 'passed') {
            statusDot.classList.add('passed');
            statusLabel.textContent = 'Status: Zaliczone';
        } else if (status === 'failed') {
            statusDot.classList.add('failed');
            statusLabel.textContent = 'Status: Błędy';
        } else if (status === 'running') {
            statusDot.classList.add('running');
            statusLabel.textContent = 'Status: W trakcie...';
        } else {
            statusDot.classList.add('idle');
            statusLabel.textContent = 'Status: Idle';
        }
    }

    function renderTestList(tests) {
        if (!tests || !tests.length) {
            testListDiv.innerHTML = '<div class="alert alert-info">Brak wyników testów.</div>';
            return;
        }
        let html = '<div class="list-group">';
        for (const t of tests) {
            let statusIcon = '';
            let itemClass = 'list-group-item d-flex justify-content-between align-items-center';
            if (t.status === 'ok') {
                statusIcon = '<span class="badge bg-success rounded-pill">✔</span>';
                itemClass += ' test-ok';
            } else if (t.status === 'FAIL') {
                statusIcon = '<span class="badge bg-danger rounded-pill">✖</span>';
                itemClass += ' test-fail';
            } else if (t.status === 'ERROR') {
                statusIcon = '<span class="badge bg-warning text-dark rounded-pill">!</span>';
                itemClass += ' test-error';
            } else {
                statusIcon = '<span class="badge bg-secondary rounded-pill">?</span>';
            }
            html += `<div class="${itemClass}">
                <div>
                    <span class="fw-bold">${t.name}</span>
                    ${t.class ? `<span class="text-muted ms-2">(${t.class})</span>` : ''}
                    <span class="ms-2">${statusIcon}</span>
                </div>
                <div>
                    <span class="fw-bold">${t.status}</span>
                    ${t.details ? `<button class="btn btn-link btn-sm ms-2" type="button" onclick="this.nextElementSibling.classList.toggle('d-none')">Szczegóły</button>
                    <div class='alert alert-danger mt-2 mb-0 d-none' style='white-space:pre-wrap;font-size:0.95em;'>${t.details}</div>` : ''}
                </div>
            </div>`;
        }
        html += '</div>';
        testListDiv.innerHTML = html;
    }

    function pollStatus() {
        fetch('/api/test_status').then(r => r.json()).then(data => {
            setStatus(data.running ? 'running' : (data.result || 'idle'));
            summaryDiv.textContent = data.summary || '';
            aiSummaryDiv.textContent = data.ai_summary ? 'AI: ' + data.ai_summary : '';
            logDiv.textContent = data.log || '';
            renderTestList(data.tests);
            if (data.running) {
                setTimeout(pollStatus, 1000);
            } else {
                polling = false;
            }
        });
    }

    runBtn.addEventListener('click', () => {
        fetch('/api/run_tests', {method: 'POST'}).then(r => {
            if (r.ok) {
                polling = true;
                pollStatus();
            } else {
                r.json().then(data => alert('Testy już trwają!'));
            }
        });
        setStatus('running');
        summaryDiv.textContent = '';
        aiSummaryDiv.textContent = '';
        logDiv.textContent = '';
        testListDiv.innerHTML = '';
    });

    pollStatus();

    // Benchmark controls
    const benchBtn = document.getElementById('run-bench-btn');
    const benchDot = document.getElementById('bench-status-dot');
    const benchLabel = document.getElementById('bench-status-label');
    const benchSummaryDiv = document.getElementById('bench-summary');
    const benchLogDiv = document.getElementById('bench-log');
    let benchPolling = false;

    function setBenchStatus(status) {
        benchDot.className = '';
        if (status === 'running') {
            benchDot.classList.add('running'); benchLabel.textContent = 'Status: W trakcie...';
        } else if (status === 'completed') {
            benchDot.classList.add('passed'); benchLabel.textContent = 'Status: Zakończone';
        } else if (status === 'error') {
            benchDot.classList.add('failed'); benchLabel.textContent = 'Status: Błąd';
        } else {
            benchDot.classList.add('idle'); benchLabel.textContent = 'Status: Idle';
        }
    }

    function pollBench() {
        fetch('/api/bench_status').then(r => r.json()).then(data => {
            setBenchStatus(data.running ? 'running' : (data.summary && !data.running ? 'completed' : 'idle'));
            benchSummaryDiv.textContent = data.summary || '';
            benchLogDiv.textContent = data.log || '';
            if (data.running) {
                setTimeout(pollBench, 1000);
            } else {
                benchPolling = false;
            }
        });
    }

    benchBtn.addEventListener('click', () => {
        fetch('/api/run_benchmarks', {method: 'POST'}).then(r => {
            if (r.ok) {
                benchPolling = true;
                pollBench();
            } else {
                alert('Benchmark już trwa!');
            }
        });
        setBenchStatus('running'); benchSummaryDiv.textContent = ''; benchLogDiv.textContent = '';
    });
    // Initial status fetch
    pollBench();
    // Test history
    async function loadTestHistory() {
        const res = await fetch('/api/test_history');
        const history = await res.json();
        const tbody = document.querySelector('#test-history-table tbody');
        tbody.innerHTML = '';
        history.slice().reverse().forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(entry.timestamp).toLocaleString()}</td>
                <td>${entry.result}</td>
                <td>${entry.summary}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    loadTestHistory();
    setInterval(loadTestHistory, 30000); // odśwież co 30s

    // Scheduling tests
    async function loadScheduleStatus() {
        const res = await fetch('/api/schedule_status');
        const data = await res.json();
        const label = document.getElementById('schedule-status-label');
        if (data.scheduled_interval) {
            label.textContent = `Zaplanowano co ${data.scheduled_interval} min.`;
        } else {
            label.textContent = 'Brak harmonogramu';
        }
    }
    document.getElementById('schedule-tests-form').onsubmit = async function(e) {
        e.preventDefault();
        const mins = document.getElementById('schedule-interval').value;
        const res = await fetch('/api/schedule_tests', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({interval: mins})
        });
        if (res.ok) {
            loadScheduleStatus();
        } else {
            const err = await res.json(); alert(err.error || 'Błąd planowania');
        }
    };
    loadScheduleStatus();

    // User management JS
    document.getElementById('add-user-form').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        const statusDiv = document.getElementById('add-user-status');
        statusDiv.textContent = '';
        const resp = await fetch('/dev/users/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (result.success) {
            statusDiv.textContent = 'Dodano użytkownika!';
            window.location.reload();
        } else {
            statusDiv.textContent = result.error || 'Błąd dodawania użytkownika.';
        }
    };
    document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.onclick = async function() {
            if (!confirm('Na pewno usunąć użytkownika?')) return;
            const username = btn.getAttribute('data-username');
            const resp = await fetch('/dev/users/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            const result = await resp.json();
            if (result.success) {
                window.location.reload();
            } else {
                alert(result.error || 'Błąd usuwania użytkownika.');
            }
        };
    });
    </script>
    <style>
        #test-log { white-space: pre-wrap; background: #222; color: #eee; padding: 1em; border-radius: 6px; max-height: 300px; overflow-y: auto; }
        #test-summary, #ai-summary { margin-top: 1em; font-weight: bold; }
        #test-status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        #test-status-dot.passed { background: #4caf50; }
        #test-status-dot.failed { background: #f44336; }
        #test-status-dot.running { background: #ffc107; }
        #test-status-dot.idle { background: #888; }
        .list-group-item.test-ok { border-left: 6px solid #4caf50; }
        .list-group-item.test-fail { border-left: 6px solid #f44336; }
        .list-group-item.test-error { border-left: 6px solid #ffc107; }
        .list-group-item { margin-bottom: 0.5em; }
    </style>
{% endblock %}
